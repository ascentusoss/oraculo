{"version":3,"file":"comando-reverter.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-reverter.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport { mapaReversao } from '@analistas/corrections/mapa-reversao.js';\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport { CliComandoReverterMessages } from '@core/messages/cli/cli-comando-reverter-messages.js';\nimport {\n  ICONES_DIAGNOSTICO,\n  log,\n  logAuto,\n  logSistema,\n} from '@core/messages/index.js';\nimport { Command } from 'commander';\n\nexport function registrarComandoReverter(program: Command): void {\n  program\n    .command('reverter')\n    .description('Gerencia mapa de reversão para moves aplicados')\n    .hook('preAction', async () => {\n      if (process.env.ORACULO_TEST_FAST === '1') {\n        try {\n          await mapaReversao.carregar();\n        } catch (err) {\n          // Em modo de teste rápido, falhas ao carregar o mapa são ignoradas para evitar timeout.\n          // Porém, em outros ambientes, registramos um aviso para reduzir casos de promises 'swallowed'.\n          if (process.env.VITEST === '1') return;\n          log.aviso(\n            `Falha ao carregar mapa de reversão (fast-mode): ${err instanceof Error ? err.message : String(err)}`,\n          );\n        }\n      }\n    })\n    .addCommand(\n      new Command('listar')\n        .description('Lista todos os moves registrados no mapa de reversão')\n        .action(async () => {\n          try {\n            await mapaReversao.carregar();\n            const _lista = mapaReversao.listarMoves();\n          } catch (err) {\n            log.erro(\n              `Falha ao listar moves: ${err instanceof Error ? err.message : String(err)}`,\n            );\n            sair(ExitCode.Failure);\n          }\n        }),\n    )\n    .addCommand(\n      new Command('arquivo')\n        .description('Reverte todos os moves de um arquivo específico')\n        .argument('<arquivo>', 'Caminho do arquivo para reverter')\n        .action(async (arquivo: string) => {\n          try {\n            await mapaReversao.carregar();\n\n            if (!mapaReversao.podeReverterArquivo(arquivo)) {\n              logSistema.reversaoNenhumMove(arquivo);\n              sair(ExitCode.Failure);\n              return;\n            }\n\n            logSistema.reversaoRevertendo(arquivo);\n            const sucesso = await mapaReversao.reverterArquivo(arquivo);\n\n            if (sucesso) {\n              logSistema.reversaoSucesso(arquivo);\n            } else {\n              logSistema.reversaoFalha(arquivo);\n              sair(ExitCode.Failure);\n              return;\n            }\n          } catch (err) {\n            log.erro(\n              `Falha ao reverter arquivo: ${err instanceof Error ? err.message : String(err)}`,\n            );\n            sair(ExitCode.Failure);\n          }\n        }),\n    )\n    .addCommand(\n      new Command('move')\n        .description('Reverte um move específico pelo ID')\n        .argument('<id>', 'ID do move para reverter')\n        .action(async (id: string) => {\n          try {\n            await mapaReversao.carregar();\n\n            logAuto.mapaReversaoRevertendoMove(id);\n            const sucesso = await mapaReversao.reverterMove(id);\n\n            if (sucesso) {\n              logAuto.mapaReversaoMoveRevertido(id);\n            } else {\n              logAuto.mapaReversaoFalhaReverterMove(id);\n              sair(ExitCode.Failure);\n              return;\n            }\n          } catch (err) {\n            log.erro(\n              `Falha ao reverter move: ${err instanceof Error ? err.message : String(err)}`,\n            );\n            sair(ExitCode.Failure);\n          }\n        }),\n    )\n    .addCommand(\n      new Command('limpar')\n        .description('Limpa todo o mapa de reversão (perde histórico)')\n        .option('-f, --force', 'Não pede confirmação')\n        .action(async (options: { force?: boolean }) => {\n          try {\n            await mapaReversao.carregar();\n\n            if (!options.force) {\n              sair(ExitCode.Failure);\n              return;\n            }\n\n            await mapaReversao.limpar();\n            log.sucesso(\n              CliComandoReverterMessages.mapaLimpoComSucesso(\n                ICONES_DIAGNOSTICO.sucesso,\n              ),\n            );\n          } catch (err) {\n            log.erro(\n              `Falha ao limpar mapa: ${err instanceof Error ? err.message : String(err)}`,\n            );\n            sair(ExitCode.Failure);\n          }\n        }),\n    )\n    .addCommand(\n      new Command('status')\n        .description('Mostra status do mapa de reversão')\n        .action(async () => {\n          try {\n            await mapaReversao.carregar();\n            const moves = mapaReversao.obterMoves();\n            if (moves.length > 0) {\n              const ultimoMove = moves.sort(\n                (a, b) =>\n                  new Date(b.timestamp).getTime() -\n                  new Date(a.timestamp).getTime(),\n              )[0];\n\n              const dataPtBr = new Date(ultimoMove.timestamp).toLocaleString(\n                'pt-BR',\n              );\n              log.info(CliComandoReverterMessages.ultimoMove(dataPtBr));\n            }\n          } catch (err) {\n            log.erro(\n              `Falha ao obter status: ${err instanceof Error ? err.message : String(err)}`,\n            );\n            sair(ExitCode.Failure);\n          }\n        }),\n    );\n}\n"]}