{"version":3,"file":"comando-podar.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-podar.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n\nimport { removerArquivosOrfaos } from '/corrections/poda.js';\nimport { exportarRelatoriosPoda } from '/handlers/poda-exporter.js';\nimport { ExitCode, sair } from '/helpers/exit-codes.js';\nimport {\n  expandIncludePatterns,\n  processPatternList,\n} from '/helpers/pattern-helpers.js';\nimport chalk from '/config/chalk-safe.js';\nimport { config } from '/config/config.js';\nimport { iniciarInquisicao } from '/execution/inquisidor.js';\nimport { CliComandoPodarMessages } from '/messages/cli/cli-comando-podar-messages.js';\nimport { ICONES_DIAGNOSTICO, log, logSistema } from '/messages/index.js';\nimport { Command } from 'commander';\n\nimport type { ArquivoFantasma, ResultadoPoda } from '@';\n\nexport function comandoPodar(\n  aplicarFlagsGlobais: (opts: Record<string, unknown>) => void,\n): Command {\n  return new Command('podar')\n    .description('Remove arquivos √≥rf√£os e lixo do reposit√≥rio.')\n    .option('-f, --force', 'Remove arquivos sem confirma√ß√£o (CUIDADO!)', false)\n    .option(\n      '--include <padrao>',\n      'Glob pattern a INCLUIR (pode repetir a flag ou usar v√≠rgulas / espa√ßos para m√∫ltiplos)',\n      (val: string, prev: string[]) => {\n        prev.push(val);\n        return prev;\n      },\n      [] as string[],\n    )\n    .option(\n      '--exclude <padrao>',\n      'Glob pattern a EXCLUIR adicionalmente (pode repetir a flag ou usar v√≠rgulas / espa√ßos)',\n      (val: string, prev: string[]) => {\n        prev.push(val);\n        return prev;\n      },\n      [] as string[],\n    )\n    .action(async function (\n      this: Command,\n      opts: { force?: boolean; include?: string[]; exclude?: string[] },\n    ) {\n      try {\n        await aplicarFlagsGlobais(\n          this.parent && typeof this.parent.opts === 'function'\n            ? this.parent.opts()\n            : {},\n        );\n      } catch (err) {\n        log.erro(\n          `Falha ao aplicar flags: ${err instanceof Error ? err.message : String(err)}`,\n        );\n        sair(ExitCode.Failure);\n        return;\n      }\n\n      log.info(chalk.bold(CliComandoPodarMessages.inicio));\n\n      const baseDir = process.cwd();\n\n      try {\n        // Normaliza padr√µes de include/exclude para sincronizar filtros com o scanner\n        const includeListRaw = processPatternList(opts.include);\n        const includeList = includeListRaw.length\n          ? expandIncludePatterns(includeListRaw)\n          : [];\n        const excludeList = processPatternList(opts.exclude);\n        if (includeList.length) config.CLI_INCLUDE_PATTERNS = includeList;\n        if (excludeList.length) config.CLI_EXCLUDE_PATTERNS = excludeList;\n\n        // üî• SIMPLIFICADO: sem sync de padr√µes obsoletos\n        // CLI flags dominam globalExcludeGlob automaticamente\n\n        const { fileEntries } = await iniciarInquisicao(baseDir, {\n          incluirMetadados: false,\n        });\n        const resultadoPoda: ResultadoPoda =\n          await removerArquivosOrfaos(fileEntries);\n        if (resultadoPoda.arquivosOrfaos.length === 0) {\n          log.sucesso(\n            CliComandoPodarMessages.nenhumaSujeira(ICONES_DIAGNOSTICO.sucesso),\n          );\n          await exportarRelatoriosPoda({\n            baseDir,\n            podados: [],\n            pendentes: [],\n            simulado: !opts.force,\n          });\n          return;\n        }\n\n        log.aviso(\n          CliComandoPodarMessages.orfaosDetectados(\n            resultadoPoda.arquivosOrfaos.length,\n          ),\n        );\n        resultadoPoda.arquivosOrfaos.forEach((file: ArquivoFantasma) => {\n          log.info(CliComandoPodarMessages.linhaArquivoOrfao(file.arquivo));\n        });\n\n        if (!opts.force) {\n          const readline = await import('node:readline/promises');\n          const rl = readline.createInterface({\n            input: process.stdin,\n            output: process.stdout,\n          });\n\n          const answer = await rl.question(\n            chalk.yellow(CliComandoPodarMessages.confirmarRemocao),\n          );\n          rl.close();\n\n          // debug removido (usava console.log) ‚Äì manter somente se modo debug ativo futuramente\n          if (answer.toLowerCase() !== 's') {\n            logSistema.podaCancelada();\n            return;\n          }\n        }\n\n        // S√≥ remove se confirmado\n        // --force: remove direto\n        if (opts.force) {\n          await removerArquivosOrfaos(fileEntries);\n          logSistema.podaConcluida();\n\n          const podados = resultadoPoda.arquivosOrfaos.map((f) => ({\n            arquivo: f.arquivo,\n            motivo: f.referenciado ? 'inativo' : '√≥rf√£o',\n            detectedAt: Date.now(),\n            scheduleAt: Date.now(),\n          }));\n\n          await exportarRelatoriosPoda({\n            baseDir,\n            podados,\n            pendentes: [],\n            simulado: false,\n          });\n        }\n      } catch (error) {\n        const errMsg =\n          typeof error === 'object' && error && 'message' in error\n            ? (error as { message: string }).message\n            : String(error);\n        log.erro(CliComandoPodarMessages.erroDurantePoda(errMsg));\n        if (config.DEV_MODE) console.error(error);\n        sair(ExitCode.Failure);\n        return;\n      }\n    });\n}\n"]}