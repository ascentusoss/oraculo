{"version":3,"file":"comando-metricas.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-metricas.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// @oraculo-disable tipo-literal-inline-complexo\n// Justificativa: tipos inline para opções de comando CLI são locais e não precisam de extração\nimport path from 'node:path';\n\nimport { ExitCode, sair } from '@cli/helpers/exit-codes.js';\nimport { config } from '@core/config/config.js';\nimport { formatMs } from '@core/config/format.js';\nimport { CliComandoMetricasMessages } from '@core/messages/cli/cli-comando-metricas-messages.js';\nimport { ICONES_DIAGNOSTICO, log, logMetricas } from '@core/messages/index.js';\nimport { lerEstado, salvarEstado } from '@shared/persistence/persistencia.js';\nimport { Command } from 'commander';\n\nimport type { MetricaExecucao } from '@';\n\ninterface RegistroHistorico extends MetricaExecucao {\n  timestamp: number;\n}\n\nconst formatarDuracao = (ms: number) => formatMs(ms);\n\nfunction agregados(historico: RegistroHistorico[]) {\n  if (!historico.length) return null;\n  const total = historico.length;\n  const somaAnalise = historico.reduce(\n    (acc, h) => acc + (h.tempoAnaliseMs ?? 0),\n    0,\n  );\n  const somaParsing = historico.reduce(\n    (acc, h) => acc + (h.tempoParsingMs ?? 0),\n    0,\n  );\n  const analistasMap = new Map<\n    string,\n    { totalMs: number; execucoes: number; ocorrencias: number }\n  >();\n  for (const h of historico) {\n    if (!h.analistas) continue;\n    for (const a of h.analistas) {\n      const dado = analistasMap.get(a.nome) || {\n        totalMs: 0,\n        execucoes: 0,\n        ocorrencias: 0,\n      };\n      dado.totalMs += a.duracaoMs;\n      dado.execucoes += 1;\n      dado.ocorrencias += a.ocorrencias;\n      analistasMap.set(a.nome, dado);\n    }\n  }\n  const analistasOrdenados = [...analistasMap.entries()]\n    .sort((a, b) => b[1].totalMs - a[1].totalMs)\n    .slice(0, 5)\n    .map(([nome, d]) => ({\n      nome,\n      totalMs: d.totalMs,\n      mediaMs: d.totalMs / d.execucoes,\n      execucoes: d.execucoes,\n      ocorrencias: d.ocorrencias,\n    }));\n  return {\n    totalExecucoes: total,\n    mediaAnaliseMs: somaAnalise / total,\n    mediaParsingMs: somaParsing / total,\n    topAnalistas: analistasOrdenados,\n  };\n}\n\nexport function comandoMetricas(): Command {\n  return new Command('metricas')\n    .description('Inspeciona histórico de métricas de execuções anteriores')\n    .option('-j, --json', 'Saída em JSON bruto (historico e agregados)')\n    .option(\n      '-l, --limite <n>',\n      'Quantidade de registros mais recentes (default 10)',\n      (v) => Number(v),\n      10,\n    )\n    .option(\n      '-e, --export <arquivo>',\n      'Exporta histórico completo em JSON para arquivo',\n    )\n    .option('-a, --analistas', 'Exibe tabela agregada por analista (top 5)')\n    .action(\n      async (opts: {\n        json?: boolean;\n        limite?: number;\n        export?: string;\n        analistas?: boolean;\n      }) => {\n        try {\n          const caminho = config.ANALISE_METRICAS_HISTORICO_PATH;\n          const historico = await lerEstado<RegistroHistorico[]>(caminho).catch(\n            () => [],\n          );\n          const lista = Array.isArray(historico) ? historico : [];\n          const ultimos = opts.limite ? lista.slice(-opts.limite) : lista;\n          const agg = agregados(lista) || undefined;\n\n          if (opts.export) {\n            const destino = path.isAbsolute(opts.export)\n              ? opts.export\n              : path.join(process.cwd(), opts.export);\n            await salvarEstado(destino, {\n              exportadoEm: new Date().toISOString(),\n              total: lista.length,\n              historico: lista,\n            });\n            log.sucesso(CliComandoMetricasMessages.historicoExportado(destino));\n            return;\n          }\n\n          if (opts.json) {\n            // Emite JSON puro (sem prefixos de log) para facilitar piping / CI\n            console.log(\n              JSON.stringify(\n                {\n                  total: lista.length,\n                  limite: opts.limite,\n                  historico: ultimos,\n                  agregados: agg,\n                },\n                null,\n                2,\n              ),\n            );\n            return;\n          }\n\n          logMetricas.execucoesRegistradas(lista.length);\n          if (!lista.length) {\n            logMetricas.nenhumHistorico();\n            return;\n          }\n          for (const h of ultimos) {\n            const timestampISO = new Date(h.timestamp).toISOString();\n            log.info(\n              CliComandoMetricasMessages.linhaExecucao(\n                timestampISO,\n                h.totalArquivos ?? 0,\n                formatarDuracao(h.tempoAnaliseMs ?? 0),\n                formatarDuracao(h.tempoParsingMs ?? 0),\n                h.cacheAstHits ?? 0,\n                h.cacheAstMiss ?? 0,\n              ),\n            );\n          }\n          if (opts.analistas && agg) {\n            log.info(CliComandoMetricasMessages.linhaEmBranco);\n            log.info(\n              CliComandoMetricasMessages.tituloTopAnalistas(\n                ICONES_DIAGNOSTICO.info,\n              ),\n            );\n            for (const a of agg.topAnalistas) {\n              log.info(\n                CliComandoMetricasMessages.linhaTopAnalista(\n                  a.nome,\n                  formatMs(a.totalMs),\n                  formatMs(a.mediaMs),\n                  a.execucoes,\n                  a.ocorrencias,\n                ),\n              );\n            }\n          }\n          if (agg) {\n            log.info(\n              CliComandoMetricasMessages.medias(\n                formatMs(agg.mediaAnaliseMs),\n                formatMs(agg.mediaParsingMs),\n              ),\n            );\n          }\n        } catch (err) {\n          log.erro(\n            `Falha ao processar métricas: ${err instanceof Error ? err.message : String(err)}`,\n          );\n          sair(ExitCode.Failure);\n        }\n      },\n    );\n}\n"]}