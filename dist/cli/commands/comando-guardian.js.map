{"version":3,"file":"comando-guardian.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-guardian.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n//  tipo-literal-inline-complexo\n// Justificativa: tipos inline para opções de comando CLI são locais e não precisam de extração\n// Importar handler modular do Guardian (Sprint 2)\nimport {\n  executarGuardian as executarGuardianModular,\n  type GuardianOptions,\n} from '/diagnostico/handlers/guardian-handler.js';\nimport { ExitCode, sair } from '/helpers/exit-codes.js';\nimport { config } from '/config/config.js';\nimport { iniciarInquisicao } from '/execution/inquisidor.js';\nimport { CliComandoGuardianMessages } from '/messages/cli/cli-comando-guardian-messages.js';\nimport { log, logGuardian } from '/messages/index.js';\nimport { acceptNewBaseline } from '/sentinela.js';\nimport { Command } from 'commander';\n\nimport type { FileEntry, FileEntryWithAst } from '@';\nimport { extrairMensagemErro, IntegridadeStatus } from '@';\n\nexport function comandoGuardian(\n  aplicarFlagsGlobais: (opts: Record<string, unknown>) => void,\n): Command {\n  return (\n    new Command('guardian')\n      .description('Gerencia e verifica a integridade do ambiente do Oráculo.')\n      // Alinhar com comportamento tolerante usado em outros comandos/testes\n      .allowUnknownOption(true)\n      .allowExcessArguments(true)\n      .option(\n        '-a, --accept-baseline',\n        'Aceita o baseline atual como o novo baseline de integridade',\n      )\n      .option(\n        '-d, --diff',\n        'Mostra as diferenças entre o estado atual e o baseline',\n      )\n      .option(\n        '--full-scan',\n        'Executa verificação sem aplicar GUARDIAN_IGNORE_PATTERNS (não persistir baseline)',\n      )\n      .option('--json', 'Saída em JSON estruturado (para CI/integracoes)')\n      .action(async function (\n        this: Command,\n        opts: {\n          acceptBaseline?: boolean;\n          diff?: boolean;\n          fullScan?: boolean;\n          json?: boolean;\n        },\n      ) {\n        try {\n          await aplicarFlagsGlobais(\n            this.parent && typeof this.parent.opts === 'function'\n              ? this.parent.opts()\n              : {},\n          );\n        } catch (err) {\n          log.erro(\n            `Falha ao aplicar flags: ${err instanceof Error ? err.message : String(err)}`,\n          );\n          sair(ExitCode.Failure);\n          return;\n        }\n\n        const baseDir = process.cwd();\n        let fileEntries: FileEntryWithAst[] = [];\n\n        try {\n          const resultadoInquisicao = await iniciarInquisicao(baseDir, {\n            incluirMetadados: false,\n          });\n          fileEntries = resultadoInquisicao.fileEntries;\n          const ignoradosOriginaisRaw = (\n            config as { GUARDIAN_IGNORE_PATTERNS?: string[] }\n          ).GUARDIAN_IGNORE_PATTERNS;\n          const ignoradosOriginais = Array.isArray(ignoradosOriginaisRaw)\n            ? [...ignoradosOriginaisRaw]\n            : [];\n          if (opts.fullScan) {\n            // Temporariamente desabilita padrões ignorados\n            (\n              config as unknown as { GUARDIAN_IGNORE_PATTERNS: string[] }\n            ).GUARDIAN_IGNORE_PATTERNS = [];\n            if (!opts.acceptBaseline) {\n              logGuardian.fullScanAviso();\n            }\n          }\n\n          if (opts.acceptBaseline) {\n            if (opts.fullScan) {\n              log.aviso(\n                CliComandoGuardianMessages.baselineNaoPermitidoFullScan,\n              );\n              (\n                config as unknown as { GUARDIAN_IGNORE_PATTERNS: string[] }\n              ).GUARDIAN_IGNORE_PATTERNS = ignoradosOriginais;\n              sair(ExitCode.Failure);\n              return;\n            }\n            logGuardian.aceitandoBaseline();\n            await acceptNewBaseline(fileEntries);\n            if (opts.json) {\n              console.log(\n                JSON.stringify({\n                  status: IntegridadeStatus.Aceito,\n                  baseline: true,\n                }),\n              );\n            } else {\n              logGuardian.baselineAceitoSucesso();\n            }\n          } else {\n            // REFATORADO: Usar handler modular do Guardian\n            const guardianOpts: GuardianOptions = {\n              enabled: true,\n              fullScan: Boolean(opts.fullScan),\n              saveBaseline: false,\n              silent: Boolean(opts.json),\n            };\n\n            const guardianResult = await executarGuardianModular(\n              fileEntries.map((e) => ({\n                relPath: e.relPath,\n                fullPath: e.fullPath,\n                content: e.content,\n              })) as FileEntry[],\n              guardianOpts,\n            );\n\n            // Processar resultado baseado no modo\n            if (opts.diff) {\n              // Modo diff: mostrar diferenças\n              if (guardianResult.drift && guardianResult.drift > 0) {\n                if (opts.json) {\n                  console.log(\n                    JSON.stringify({\n                      status: 'alteracoes-detectadas',\n                      drift: guardianResult.drift,\n                    }),\n                  );\n                } else {\n                  logGuardian.diferencasDetectadas();\n                  log.aviso(\n                    CliComandoGuardianMessages.diffMudancasDetectadas(\n                      guardianResult.drift,\n                    ),\n                  );\n                  log.aviso(CliComandoGuardianMessages.diffComoAceitarMudancas);\n                }\n                sair(ExitCode.Failure);\n                return;\n              } else {\n                if (opts.json) {\n                  console.log(JSON.stringify({ status: 'ok', drift: 0 }));\n                } else {\n                  logGuardian.integridadePreservada();\n                }\n              }\n            } else {\n              // Modo normal: verificar integridade\n              const statusNorm = guardianResult.status || IntegridadeStatus.Ok;\n\n              switch (statusNorm) {\n                case IntegridadeStatus.Ok:\n                  if (opts.json)\n                    console.log(\n                      JSON.stringify({\n                        status: 'ok',\n                        cacheDiffHits:\n                          (\n                            globalThis as unknown as {\n                              __ORACULO_DIFF_CACHE_HITS__?: number;\n                            }\n                          ).__ORACULO_DIFF_CACHE_HITS__ || 0,\n                      }),\n                    );\n                  else logGuardian.integridadeOk();\n                  break;\n                case IntegridadeStatus.Criado:\n                  if (opts.json)\n                    console.log(\n                      JSON.stringify({\n                        status: 'baseline-criado',\n                        cacheDiffHits:\n                          (\n                            globalThis as unknown as {\n                              __ORACULO_DIFF_CACHE_HITS__?: number;\n                            }\n                          ).__ORACULO_DIFF_CACHE_HITS__ || 0,\n                      }),\n                    );\n                  else logGuardian.baselineCriadoConsole();\n                  log.aviso(\n                    CliComandoGuardianMessages.baselineCriadoComoAceitar,\n                  );\n                  break;\n                case IntegridadeStatus.Aceito:\n                  if (opts.json)\n                    console.log(\n                      JSON.stringify({\n                        status: 'baseline-aceito',\n                        cacheDiffHits:\n                          (\n                            globalThis as unknown as {\n                              __ORACULO_DIFF_CACHE_HITS__?: number;\n                            }\n                          ).__ORACULO_DIFF_CACHE_HITS__ || 0,\n                      }),\n                    );\n                  else logGuardian.baselineAtualizado();\n                  break;\n                case IntegridadeStatus.AlteracoesDetectadas: {\n                  if (opts.json) {\n                    console.log(\n                      JSON.stringify({\n                        status: 'alteracoes-detectadas',\n                        temProblemas: guardianResult.temProblemas,\n                        drift: guardianResult.drift,\n                      }),\n                    );\n                  } else {\n                    logGuardian.alteracoesSuspeitas();\n                  }\n                  sair(ExitCode.Failure);\n                  return;\n                }\n              }\n            }\n          }\n          if (opts.fullScan) {\n            // Restaura padrões originais após execução\n            (\n              config as unknown as { GUARDIAN_IGNORE_PATTERNS: string[] }\n            ).GUARDIAN_IGNORE_PATTERNS = ignoradosOriginais;\n          }\n        } catch (err) {\n          logGuardian.erroGuardian((err as Error).message ?? String(err));\n          if (config.DEV_MODE) {\n            console.error(extrairMensagemErro(err));\n            if (err && typeof err === 'object' && 'stack' in err) {\n              console.error((err as { stack?: string }).stack);\n            }\n          }\n          if (opts.json)\n            console.log(\n              JSON.stringify({\n                status: 'erro',\n                mensagem: extrairMensagemErro(err),\n              }),\n            );\n          sair(ExitCode.Failure);\n          return;\n        }\n      })\n  );\n}\n"]}