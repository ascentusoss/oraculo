{"version":3,"file":"comando-diagnosticar.js","sourceRoot":"","sources":["../../../src/cli/commands/comando-diagnosticar.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n//  tipo-literal-inline-complexo\n// Justificativa: tipos inline para opções de comando CLI são locais e não precisam de extração\nimport { optionsDiagnosticar } from '/options-diagnosticar.js';\nimport { processarDiagnostico } from '/processamento-diagnostico.js';\nimport { CliComandoDiagnosticarMessages } from '/messages/cli/cli-comando-diagnosticar-messages.js';\nimport { CABECALHOS, log } from '/messages/index.js';\nimport { ativarModoJson } from '/helpers/json-mode.js';\nimport { Command } from 'commander';\nimport ora from 'ora';\n\nimport type { ParentWithOpts } from '@';\n\nexport function comandoDiagnosticar(\n  aplicarFlagsGlobais: (opts: Record<string, unknown>) => void,\n): Command {\n  const cmd = new Command('diagnosticar')\n    .alias('diag')\n    .description('Executa uma análise completa do repositório');\n\n  // Em modo padrão, ignoramos opções desconhecidas para evitar saídas forçadas do Commander\n  // (comportamento desejado também pelos testes de opções inválidas)\n  cmd.allowUnknownOption(true);\n  // Também aceitamos argumentos excedentes silenciosamente, pois diversos testes\n  // passam o nome do comando na linha simulada (ex.: ['node','cli','diagnosticar', ...])\n  // e o Commander trataria como \"excess arguments\" por padrão.\n  cmd.allowExcessArguments(true);\n\n  // Adiciona opções centralizadas\n  for (const opt of optionsDiagnosticar) {\n    if ('parser' in opt && opt.parser) {\n      cmd.option(opt.flags, opt.desc, opt.parser, opt.defaultValue);\n    } else if ('defaultValue' in opt) {\n      cmd.option(opt.flags, opt.desc, opt.defaultValue);\n    } else {\n      cmd.option(opt.flags, opt.desc);\n    }\n  }\n\n  cmd.action(\n    async (\n      opts: {\n        guardianCheck?: boolean;\n        json?: boolean;\n        include?: string[];\n        exclude?: string[];\n        listarAnalistas?: boolean;\n        detalhado?: boolean;\n        criarArquetipo?: boolean;\n        salvarArquetipo?: boolean;\n        full?: boolean;\n        fast?: boolean;\n        logLevel?: string;\n        executive?: boolean;\n        autoFix?: boolean;\n        autoFixMode?: string;\n        autoFixConservative?: boolean;\n      },\n      command: Command,\n    ) => {\n      // Aplicar flags globais (merge entre flags passadas antes do subcomando e flags locais)\n      // Isso garante que opções como --export funcionem tanto quando fornecidas antes quanto depois do subcomando\n      try {\n        const parentObj = command.parent as unknown as\n          | { opts?: () => Record<string, unknown> }\n          | undefined;\n        const parentFlags =\n          parentObj && typeof parentObj.opts === 'function'\n            ? parentObj.opts()\n            : {};\n        const localFlags =\n          typeof command.opts === 'function' ? command.opts() : {};\n        const merged = {\n          ...(parentFlags || {}),\n          ...(localFlags || {}),\n          ...(opts || {}),\n        };\n        await aplicarFlagsGlobais(merged);\n      } catch {\n        // Em caso de erro ao aplicar flags, ainda tentamos aplicar as flags locais de forma conservadora\n        try {\n          await aplicarFlagsGlobais(opts as unknown as Record<string, unknown>);\n        } catch {\n          /* swallow - falha de flags não deve interromper execução aqui */\n        }\n      }\n\n      // Fast mode de teste: retorna estrutura mínima simulada sem executar análise completa\n      if (process.env.ORACULO_TEST_FAST === '1') {\n        if (opts.json) {\n          // Estrutura mínima para satisfazer consumidores dos testes\n          console.log(\n            JSON.stringify(\n              {\n                meta: {\n                  fast: true,\n                  tipo: CliComandoDiagnosticarMessages.fastModeTipo,\n                },\n                totalArquivos: 0,\n                ocorrencias: [],\n              },\n              null,\n              2,\n            ),\n          );\n          return;\n        }\n        return;\n      }\n      // Ativar modo JSON se necessário (suprime logs visuais)\n      if (opts.json) {\n        ativarModoJson();\n      }\n\n      // Antes de delegar, imprimir um bloco de sugestões/flags úteis para o usuário\n      // (APENAS em modo verbose/debug - não polui saída normal)\n      const logLevel = (opts.logLevel as string) || 'info';\n      const isVerbose = opts.full || logLevel === 'debug' || opts.detalhado;\n      if (!opts.json && isVerbose) {\n        try {\n          const { default: chalk } = await import('/config/chalk-safe.js');\n          const { config } = await import('/config/config.js');\n          const activeFlags: string[] = [];\n          const details: string[] = [];\n\n          const parent = command.parent as unknown as\n            | ParentWithOpts\n            | undefined;\n          const parentOpts: Record<string, unknown> =\n            parent && typeof parent.opts === 'function' ? parent.opts() : {};\n\n          // Mapear flags relevantes e adicionar detalhes úteis\n          if (opts.json) {\n            activeFlags.push('--json');\n            details.push(\n              CliComandoDiagnosticarMessages.detalheSaidaEstruturada,\n            );\n          }\n          if (opts.guardianCheck) {\n            activeFlags.push('--guardian-check');\n            details.push(CliComandoDiagnosticarMessages.detalheGuardian);\n          }\n          if (opts.executive) {\n            activeFlags.push('--executive');\n            details.push(CliComandoDiagnosticarMessages.detalheExecutive);\n          }\n          if (opts.full) {\n            activeFlags.push('--full');\n            details.push(CliComandoDiagnosticarMessages.detalheFull);\n          }\n          if (opts.fast) {\n            activeFlags.push('--fast');\n            details.push(CliComandoDiagnosticarMessages.detalheFast);\n          }\n          // Compact\n          const localCompact = Boolean(\n            (opts as unknown as Record<string, unknown>)['compact'],\n          );\n          const effectiveCompact =\n            localCompact || (!opts.full && !localCompact);\n          if (effectiveCompact && !opts.full) {\n            activeFlags.push('--compact');\n            details.push(CliComandoDiagnosticarMessages.detalheCompact);\n          }\n          if (opts.listarAnalistas) {\n            activeFlags.push('--listar-analistas');\n          }\n          if (opts.autoFix) {\n            activeFlags.push('--auto-fix');\n            details.push(CliComandoDiagnosticarMessages.detalheAutoFix);\n          }\n          if (opts.autoFixConservative) {\n            activeFlags.push('--auto-fix-conservative');\n            details.push(\n              CliComandoDiagnosticarMessages.detalheAutoFixConservative,\n            );\n          }\n          // include/exclude counts\n          const includes = (opts.include as string[]) || [];\n          const excludes = (opts.exclude as string[]) || [];\n          if (includes.length)\n            details.push(\n              CliComandoDiagnosticarMessages.detalheIncludePatterns(\n                includes.length,\n                includes.join(', '),\n              ),\n            );\n          if (excludes.length)\n            details.push(\n              CliComandoDiagnosticarMessages.detalheExcludePatterns(\n                excludes.length,\n                excludes.join(', '),\n              ),\n            );\n\n          // Export flags can be passed as parent/global flags\n          const parentExport = Boolean(\n            parentOpts &&\n            Object.prototype.hasOwnProperty.call(parentOpts, 'export') &&\n            Boolean(parentOpts['export']),\n          );\n          const parentExportFull = Boolean(\n            parentOpts &&\n            Object.prototype.hasOwnProperty.call(parentOpts, 'exportFull') &&\n            Boolean(parentOpts['exportFull']),\n          );\n          const localExport = Boolean(\n            (opts as unknown as Record<string, unknown>)['export'],\n          );\n          const localExportFull = Boolean(\n            (opts as unknown as Record<string, unknown>)['exportFull'],\n          );\n          if (parentExport || localExport) {\n            activeFlags.push('--export');\n            const relDir =\n              (config &&\n                (config as Record<string, unknown>)['RELATORIOS_DIR']) ||\n              'relatorios';\n            details.push(\n              CliComandoDiagnosticarMessages.detalheExport(String(relDir)),\n            );\n          }\n          if (parentExportFull || localExportFull) {\n            activeFlags.push('--export-full');\n            // manifest nome será gerado só durante execução; mencionar que shards serão criados\n            details.push(CliComandoDiagnosticarMessages.detalheExportFull);\n          }\n\n          // Log-level / debug mapping\n          const resolvedParentLogLevel =\n            parentOpts &&\n            Object.prototype.hasOwnProperty.call(parentOpts, 'logLevel')\n              ? String(parentOpts['logLevel'])\n              : undefined;\n          const logLevel =\n            (opts.logLevel as string) || resolvedParentLogLevel || 'info';\n          details.push(\n            CliComandoDiagnosticarMessages.detalheLogLevel(String(logLevel)),\n          );\n\n          // Recomendações para flags redundantes ou legadas\n          details.push(CliComandoDiagnosticarMessages.dicaPrefiraLogLevelDebug);\n          details.push(CliComandoDiagnosticarMessages.dicaAutoFixConservative);\n\n          // Mostrar bloco apenas se houver conteúdo relevante\n          if (activeFlags.length || details.length) {\n            const header = chalk.cyan(\n              CliComandoDiagnosticarMessages.sugestoesHeader,\n            );\n            const footer = chalk.cyan(\n              CliComandoDiagnosticarMessages.sugestoesFooter,\n            );\n            log.info(header);\n            if (activeFlags.length)\n              log.info(\n                chalk.yellow(`${CABECALHOS.diagnostico.flagsAtivas} `) +\n                  activeFlags.join(' '),\n              );\n            else\n              log.info(\n                chalk.gray(CliComandoDiagnosticarMessages.nenhumaFlagRelevante),\n              );\n            log.info(CliComandoDiagnosticarMessages.linhaEmBranco);\n            log.info(chalk.green(CABECALHOS.diagnostico.informacoesUteis));\n            for (const d of details)\n              log.info(CliComandoDiagnosticarMessages.detalheLinha(String(d)));\n            log.info(footer);\n          }\n        } catch {\n          // não crítico — prosseguir silenciosamente\n        }\n      }\n\n      // Spinner visual durante processamento (APENAS se não estiver em modo JSON)\n      const spinner = opts.json\n        ? { text: '', start: () => spinner, succeed: () => {}, fail: () => {} }\n        : ora({\n            text: CliComandoDiagnosticarMessages.spinnerExecutando,\n            spinner: 'dots',\n          }).start();\n      // Bridge de fases: atualizar texto do spinner conforme fases do processamento\n      try {\n        const logWithFase = log as { fase?: (t: string) => void };\n        logWithFase.fase = (t: string) => {\n          if (typeof t === 'string' && t.trim()) {\n            spinner.text = CliComandoDiagnosticarMessages.spinnerFase(t);\n          }\n        };\n      } catch {\n        /* não crítico */\n      }\n      try {\n        // Delegar todo o processamento para a função modularizada\n        await processarDiagnostico(\n          opts as unknown as import('@').OpcoesProcessamentoDiagnostico,\n        );\n        spinner.succeed(CliComandoDiagnosticarMessages.spinnerConcluido);\n      } catch (err) {\n        spinner.fail(CliComandoDiagnosticarMessages.spinnerFalhou);\n        throw err;\n      }\n    },\n  );\n  return cmd;\n}\n"]}