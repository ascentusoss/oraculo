{"version":3,"file":"filtros.js","sourceRoot":"","sources":["../../../src/cli/diagnostico/filtros.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * ðŸŽ¯ Sistema de Filtros para DiagnÃ³stico\n *\n * Gerencia inclusÃ£o/exclusÃ£o de arquivos para anÃ¡lise\n * - Processa padrÃµes glob\n * - Expande diretÃ³rios automaticamente\n * - Gerencia node_modules e outros padrÃµes especiais\n * - Aplica precedÃªncia correta (CLI > config > defaults)\n */\n\nimport fs from 'node:fs';\nimport path from 'node:path';\n\nimport { config } from '@core/config/config.js';\nimport { mesclarConfigExcludes } from '@core/config/excludes-padrao.js';\n\nimport type {\n  FiltrosProcessados,\n  OpcoesProcessamentoFiltros,\n  TipoLinguagemProjeto,\n} from '@';\n\n  /* -------------------------- PROCESSAMENTO DE PADRÃ•ES -------------------------- */\n\n/**\n * Processa lista de padrÃµes achatada (vÃ­rgulas, espaÃ§os)\n *\n * @example\n * processPatternListAchatado(['src/**', 'tests, lib'])\n * // => ['src/**', 'tests', 'lib']\n */\nexport function processPatternListAchatado(\n  raw: string[] | undefined,\n): string[] {\n  if (!raw || raw.length === 0) return [];\n\n  return Array.from(\n    new Set(\n      raw\n        .flatMap((r) => r.split(/[\\s,]+/))\n        .map((s) => s.trim())\n        .filter(Boolean),\n    ),\n  );\n}\n\n/**\n * Processa padrÃµes em grupos (cada elemento da lista Ã© um grupo)\n *\n * @example\n * processPatternGroups(['src/** tests/**', 'lib/**'])\n * // => [['src/**', 'tests/**'], ['lib/**']]\n */\nexport function processPatternGroups(raw: string[] | undefined): string[][] {\n  if (!raw || raw.length === 0) return [];\n\n  return raw\n    .map((grupo) =>\n      grupo\n        .split(/[\\s,]+/)\n        .map((s) => s.trim())\n        .filter(Boolean),\n    )\n    .filter((g) => g.length > 0);\n}\n\n/**\n * Expande padrÃµes de inclusÃ£o (adiciona variantes recursivas)\n *\n * Para padrÃµes sem metacaracteres glob, adiciona:\n * - `pattern/**` (recursivo)\n * - `** /pattern/**` (se nÃ£o tiver barra)\n *\n * @example\n * expandIncludes(['src', 'lib/*.ts'])\n * // => ['src', 'src/**', '** /src/**', 'lib/*.ts']\n */\nexport function expandIncludes(list: string[]): string[] {\n  const META = /[\\\\*\\?\\{\\}\\[\\]]/; // metacaracteres glob\n  const out = new Set<string>();\n\n  for (const p of list) {\n    out.add(p);\n\n    // Se nÃ£o tem metacaracteres, Ã© um diretÃ³rio literal\n    if (!META.test(p)) {\n      // Remove barras terminais\n      const normalized = p.replace(/[\\\\\\/]+$/, '');\n\n      // Adiciona variante recursiva\n      out.add(`${normalized}/**`);\n\n      // Se Ã© nome simples (sem barra), adiciona busca em qualquer nÃ­vel\n      if (!p.includes('/') && !p.includes('\\\\')) {\n        out.add(`**/${normalized}/**`);\n      }\n    }\n  }\n\n  return Array.from(out);\n}\n\n  /* -------------------------- DETECÃ‡ÃƒO DE TIPO DE PROJETO -------------------------- */\n\n/**\n * Detecta tipo de projeto baseado em arquivos presentes\n */\nexport function detectarTipoProjeto(\n  baseDir: string = process.cwd(),\n): TipoLinguagemProjeto {\n  try {\n    // TypeScript\n    if (\n      fs.existsSync(path.join(baseDir, 'tsconfig.json')) &&\n      fs.existsSync(path.join(baseDir, 'package.json'))\n    ) {\n      return 'typescript';\n    }\n\n    // Node.js\n    if (fs.existsSync(path.join(baseDir, 'package.json'))) {\n      return 'nodejs';\n    }\n\n    // Python\n    if (\n      fs.existsSync(path.join(baseDir, 'requirements.txt')) ||\n      fs.existsSync(path.join(baseDir, 'pyproject.toml')) ||\n      fs.existsSync(path.join(baseDir, 'setup.py'))\n    ) {\n      return 'python';\n    }\n\n    // Java\n    if (\n      fs.existsSync(path.join(baseDir, 'pom.xml')) ||\n      fs.existsSync(path.join(baseDir, 'build.gradle')) ||\n      fs.existsSync(path.join(baseDir, 'build.gradle.kts'))\n    ) {\n      return 'java';\n    }\n\n    // .NET\n    const files = fs.readdirSync(baseDir);\n    if (\n      files.some((f) => f.endsWith('.csproj')) ||\n      files.some((f) => f.endsWith('.sln'))\n    ) {\n      return 'dotnet';\n    }\n\n    return 'generico';\n  } catch {\n    return 'generico';\n  }\n}\n\n  /* -------------------------- PADRÃ•ES DE EXCLUSÃƒO -------------------------- */\n\n/**\n * ObtÃ©m padrÃµes de exclusÃ£o padrÃ£o baseados em configuraÃ§Ã£o e tipo de projeto\n */\nexport function getDefaultExcludes(\n  tipoProjeto?: TipoLinguagemProjeto,\n): string[] {\n  // Tenta obter do oraculo.config.json\n  const configIncludeExclude = config.INCLUDE_EXCLUDE_RULES;\n\n  if (configIncludeExclude?.globalExcludeGlob) {\n    if (\n      Array.isArray(configIncludeExclude.globalExcludeGlob) &&\n      configIncludeExclude.globalExcludeGlob.length > 0\n    ) {\n      return Array.from(new Set(configIncludeExclude.globalExcludeGlob));\n    }\n  }\n\n  // Fallback: usa padrÃµes do sistema baseado no tipo de projeto\n  const tipo = tipoProjeto || detectarTipoProjeto();\n  return mesclarConfigExcludes(null, tipo);\n}\n\n  /* -------------------------- CONFIGURAÃ‡ÃƒO DE FILTROS -------------------------- */\n\n/**\n * Processa e aplica filtros CLI\n *\n * PrecedÃªncia:\n * 1. CLI --exclude (mÃ¡xima)\n * 2. oraculo.config.json\n * 3. PadrÃµes do sistema (fallback)\n */\nexport function processarFiltros(\n  opcoes: OpcoesProcessamentoFiltros,\n): FiltrosProcessados {\n  const tipoProjeto = detectarTipoProjeto();\n\n  // Processar includes\n  const includeGroups = processPatternGroups(opcoes.include);\n  const includeFlat = includeGroups.flat();\n  const includeExpanded = expandIncludes(includeFlat);\n\n  // Processar excludes\n  const excludeFlat = processPatternListAchatado(opcoes.exclude);\n\n  // Determinar padrÃµes de exclusÃ£o finais\n  let excludePatterns: string[];\n  if (excludeFlat.length > 0) {\n    // CLI tem precedÃªncia\n    excludePatterns = excludeFlat;\n  } else {\n    // Usar defaults do config ou sistema\n    excludePatterns = getDefaultExcludes(tipoProjeto);\n  }\n\n  // Verificar se node_modules deve ser incluÃ­do\n  let incluiNodeModules = opcoes.forceIncludeNodeModules || false;\n  if (includeFlat.some((p) => /node_modules/.test(p))) {\n    incluiNodeModules = true;\n  }\n\n  // Remover node_modules dos excludes se explicitamente incluÃ­do\n  if (incluiNodeModules) {\n    excludePatterns = excludePatterns.filter((p) => !/node_modules/.test(p));\n  }\n\n  // Processar flag de testes\n  if (opcoes.forceIncludeTests && !includeFlat.some((p) => /tests?/.test(p))) {\n    includeExpanded.push('tests/**', 'test/**', '**/*.test.*', '**/*.spec.*');\n  }\n\n  return {\n    includeGroups,\n    includeFlat: includeExpanded,\n    excludePatterns,\n    incluiNodeModules,\n    tipoProjeto,\n  };\n}\n\n/**\n * Aplica filtros processados ao config global\n */\nexport function aplicarFiltrosAoConfig(filtros: FiltrosProcessados): void {\n  // Configurar includes\n  if (filtros.includeFlat.length > 0) {\n    config.CLI_INCLUDE_GROUPS = filtros.includeGroups;\n    config.CLI_INCLUDE_PATTERNS = filtros.includeFlat;\n  } else {\n    config.CLI_INCLUDE_GROUPS = [];\n    config.CLI_INCLUDE_PATTERNS = [];\n  }\n\n  // Configurar excludes\n  config.CLI_EXCLUDE_PATTERNS = filtros.excludePatterns;\n}\n\n/**\n * API simplificada: processa e aplica filtros em uma Ãºnica chamada\n */\nexport function configurarFiltros(\n  opcoes: OpcoesProcessamentoFiltros,\n): FiltrosProcessados {\n  const filtros = processarFiltros(opcoes);\n  aplicarFiltrosAoConfig(filtros);\n  return filtros;\n}\n"]}