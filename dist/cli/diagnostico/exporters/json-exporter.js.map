{"version":3,"file":"json-exporter.js","sourceRoot":"","sources":["../../../../src/cli/diagnostico/exporters/json-exporter.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// SPDX-FileCopyrightText: 2025 Oráculo Contributors\n\n/**\n *  cli/diagnostico/exporters/json-exporter\n *  Exportador JSON com suporte a ASCII escape e fragmentação\n *  docs/REFACTOR-CLI-DIAGNOSTICAR.md - Sprint 2\n */\n\nimport fs from 'node:fs';\nimport path from 'node:path';\n\nimport type { JsonExportOptions, Ocorrencia, RelatorioJson } from '@';\n\n// Re-export para compatibilidade\nexport type { JsonExportOptions, RelatorioJson };\n\n  /* -------------------------- Função Principal -------------------------- */\n\n/**\n * Gera relatório JSON a partir dos dados do diagnóstico\n *\n *  dados - Dados do diagnóstico\n *  options - Opções de exportação\n *  String JSON formatada\n */\nexport function gerarRelatorioJson(\n  dados: Partial<RelatorioJson>,\n  options: Partial<JsonExportOptions> = {},\n): string {\n  // Normalizar options\n  const opts: JsonExportOptions = {\n    escapeAscii: options.escapeAscii ?? true,\n    includeDetails: options.includeDetails ?? true,\n    includeContext: options.includeContext ?? false,\n    compact: options.compact ?? false,\n    maxOcorrencias: options.maxOcorrencias,\n  };\n\n  // Processar ocorrências\n  let ocorrencias = dados.ocorrencias || [];\n  if (opts.maxOcorrencias && ocorrencias.length > opts.maxOcorrencias) {\n    ocorrencias = ocorrencias.slice(0, opts.maxOcorrencias);\n  }\n\n  // Construir relatório\n  const relatorio: RelatorioJson = {\n    metadata: dados.metadata || {\n      timestamp: new Date().toISOString(),\n      schemaVersion: '1.0.0',\n      modo: 'full',\n      flags: [],\n      oraculoVersion: (() => {\n        try {\n          // Evita dependência direta de package.json fora do build\n          // Em runtime, pode ser enriquecido pela CLI\n          const pkg = JSON.parse(\n            fs.readFileSync(path.join(process.cwd(), 'package.json'), 'utf-8'),\n          );\n          return pkg.version || 'unknown';\n        } catch {\n          return 'unknown';\n        }\n      })(),\n      projectName: (() => {\n        try {\n          const pkg = JSON.parse(\n            fs.readFileSync(path.join(process.cwd(), 'package.json'), 'utf-8'),\n          );\n          return pkg.name || 'unknown';\n        } catch {\n          return 'unknown';\n        }\n      })(),\n    },\n    stats: dados.stats || {\n      arquivosAnalisados: 0,\n      arquivosComProblemas: 0,\n      totalOcorrencias: 0,\n      porNivel: { erro: 0, aviso: 0, info: 0 },\n      porCategoria: {},\n    },\n    ocorrencias: opts.includeDetails ? ocorrencias : [],\n    ...(dados.guardian && { guardian: dados.guardian }),\n    ...(dados.arquetipos && { arquetipos: dados.arquetipos }),\n    ...(dados.autoFix && { autoFix: dados.autoFix }),\n    ...(dados.linguagens && { linguagens: dados.linguagens }),\n    ...(dados.sugestoes && { sugestoes: dados.sugestoes }),\n  };\n\n  // Serializar para JSON\n  const indent = opts.compact ? 0 : 2;\n  let json = JSON.stringify(relatorio, null, indent);\n\n  // Aplicar escape ASCII se solicitado\n  if (opts.escapeAscii) {\n    json = escapeNonAscii(json);\n  }\n\n  return json;\n}\n\n  /* -------------------------- Helpers de Escape -------------------------- */\n\n/**\n * Escapa caracteres não-ASCII como \\uXXXX\n * Trata pares substitutos para emojis e caracteres fora do BMP\n */\nfunction escapeNonAscii(str: string): string {\n  let resultado = '';\n  let i = 0;\n\n  while (i < str.length) {\n    const code = str.charCodeAt(i);\n\n    // ASCII básico (0-127) - manter como está\n    if (code < 128) {\n      resultado += str[i];\n      i++;\n      continue;\n    }\n\n    // High surrogate (início de par substituto)\n    if (code >= 0xd800 && code <= 0xdbff) {\n      // Verificar se há low surrogate seguinte\n      if (i + 1 < str.length) {\n        const nextCode = str.charCodeAt(i + 1);\n        if (nextCode >= 0xdc00 && nextCode <= 0xdfff) {\n          // Par substituto válido - escapar ambos\n          resultado += `\\\\u${code.toString(16).padStart(4, '0')}`;\n          resultado += `\\\\u${nextCode.toString(16).padStart(4, '0')}`;\n          i += 2;\n          continue;\n        }\n      }\n    }\n\n    // Caractere BMP não-ASCII ou surrogate isolado\n    resultado += `\\\\u${code.toString(16).padStart(4, '0')}`;\n    i++;\n  }\n\n  return resultado;\n}\n\n/**\n * Valida se uma string JSON está bem formada\n */\nexport function validarJson(json: string): { valido: boolean; erro?: string } {\n  try {\n    JSON.parse(json);\n    return { valido: true };\n  } catch (erro) {\n    const mensagem = erro instanceof Error ? erro.message : String(erro);\n    return { valido: false, erro: mensagem };\n  }\n}\n\n  /* -------------------------- Helpers de Construção -------------------------- */\n\n/**\n * Cria objeto de metadata para o relatório\n */\nexport function criarMetadata(\n  modo: RelatorioJson['metadata']['modo'],\n  flags: string[],\n  filtros?: RelatorioJson['metadata']['filtros'],\n): RelatorioJson['metadata'] {\n  return {\n    timestamp: new Date().toISOString(),\n    schemaVersion: '1.0.0',\n    modo,\n    flags,\n    ...(filtros && { filtros }),\n  };\n}\n\n/**\n * Cria objeto de stats a partir de ocorrências\n */\nexport function criarStats(ocorrencias: Ocorrencia[]): RelatorioJson['stats'] {\n  const porNivel = { erro: 0, aviso: 0, info: 0 };\n  const porCategoria: Record<string, number> = {};\n  const porRegra: Record<string, number> = {};\n  const arquivosSet = new Set<string>();\n\n  for (const ocorrencia of ocorrencias) {\n    // Contar por nível (type-safe)\n    const nivel = ocorrencia.nivel || 'info';\n    if (nivel === 'erro' || nivel === 'aviso' || nivel === 'info') {\n      porNivel[nivel] = porNivel[nivel] + 1;\n    }\n\n    // Contar por categoria/tipo\n    const tipo = ocorrencia.tipo || 'outros';\n    porCategoria[tipo] = (porCategoria[tipo] || 0) + 1;\n    porRegra[tipo] = (porRegra[tipo] || 0) + 1;\n\n    // Rastrear arquivos únicos\n    if (ocorrencia.relPath) {\n      arquivosSet.add(ocorrencia.relPath);\n    }\n  }\n\n  const arquivosComProblemas = arquivosSet.size;\n\n  return {\n    arquivosAnalisados: arquivosSet.size,\n    arquivosComProblemas,\n    totalOcorrencias: ocorrencias.length,\n    porNivel,\n    porCategoria,\n    byRule: porRegra,\n  };\n}\n\n/**\n * Cria objeto de linguagens a partir de extensões\n */\nexport function criarLinguagens(\n  extensoes: Record<string, number>,\n): RelatorioJson['linguagens'] {\n  const total = Object.values(extensoes).reduce((sum, count) => sum + count, 0);\n\n  return {\n    total,\n    extensoes,\n  };\n}\n"]}