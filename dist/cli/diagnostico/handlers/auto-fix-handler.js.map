{"version":3,"file":"auto-fix-handler.js","sourceRoot":"","sources":["../../../../src/cli/diagnostico/handlers/auto-fix-handler.ts"],"names":[],"mappings":"AASA,OAAO,EAAE,gBAAgB,EAAE,MAAM,0CAA0C,CAAC;AAC5E,OAAO,EAAE,GAAG,EAAE,iBAAiB,EAAE,MAAM,yBAAyB,CAAC;AAgBjE,MAAM,CAAC,KAAK,UAAU,eAAe,CACnC,OAA2B,EAC3B,OAAuB;IAEvB,IAAI,CAAC;QAEH,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;YACpB,MAAM,SAAS,GAAG;gBAChB,YAAY,EAAE,aAAa;gBAC3B,QAAQ,EAAE,YAAY;gBACtB,UAAU,EAAE,WAAW;aACxB,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YAEhB,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;gBACnB,OAAO,CAAC,GAAG,CAAC,GAAG,iBAAiB,CAAC,SAAS,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC;gBACzD,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,MAAM,CAAC,CAAC;YACxC,CAAC;iBAAM,CAAC;gBACN,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC;YACtD,CAAC;QACH,CAAC;QAGD,MAAM,OAAO,GACX,OAAO,CAAC,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,KAAK,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;QACpE,MAAM,SAAS,GAAG,MAAM,kBAAkB,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;QAGtE,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;YACpB,MAAM,EAAE,kBAAkB,EAAE,GAAG,SAAS,CAAC,KAAK,CAAC;YAE/C,IAAI,OAAO,CAAC,MAAM,IAAI,SAAS,CAAC,KAAK,CAAC,kBAAkB,GAAG,CAAC,EAAE,CAAC;gBAC7D,OAAO,CAAC,GAAG,CACT,wBAAwB,SAAS,CAAC,KAAK,CAAC,kBAAkB,OAAO,SAAS,CAAC,KAAK,CAAC,kBAAkB,aAAa,CACjH,CAAC;YACJ,CAAC;iBAAM,IAAI,kBAAkB,GAAG,CAAC,EAAE,CAAC;gBAClC,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,SAAS,CAAC,kBAAkB,EAAE,CAAC,CAAC,CAAC,CAAC;YAClE,CAAC;iBAAM,CAAC;gBACN,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,aAAa,CAAC,CAAC;YAC/C,CAAC;QACH,CAAC;QAED,OAAO,SAAS,CAAC;IACnB,CAAC;IAAC,OAAO,IAAI,EAAE,CAAC;QACd,MAAM,QAAQ,GAAG,IAAI,YAAY,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAErE,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;YACpB,GAAG,CAAC,KAAK,CACP,GAAG,iBAAiB,CAAC,UAAU,CAAC,WAAW,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,QAAQ,EAAE,CACvF,CAAC;QACJ,CAAC;QAGD,OAAO;YACL,SAAS,EAAE,KAAK;YAChB,IAAI,EAAE,OAAO,CAAC,IAAI;YAClB,MAAM,EAAE,OAAO,CAAC,MAAM;YACtB,KAAK,EAAE;gBACL,kBAAkB,EAAE,CAAC;gBACrB,mBAAmB,EAAE,CAAC;gBACtB,kBAAkB,EAAE,CAAC;gBACrB,kBAAkB,EAAE,CAAC;gBACrB,gBAAgB,EAAE,CAAC;aACpB;SACF,CAAC;IACJ,CAAC;AACH,CAAC;AAKD,KAAK,UAAU,kBAAkB,CAC/B,OAA2B,EAC3B,OAAuB,EACvB,SAAiB;IAEjB,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;QACrC,MAAM,KAAK,GAAG,UAAU,CAAC,GAAG,EAAE;YAC5B,MAAM,CAAC,IAAI,KAAK,CAAC,gBAAgB,CAAC,cAAc,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;QAChE,CAAC,EAAE,SAAS,CAAC,CAAC;QAEd,sBAAsB,CAAC,OAAO,EAAE,OAAO,CAAC;aACrC,IAAI,CAAC,CAAC,SAAS,EAAE,EAAE;YAClB,YAAY,CAAC,KAAK,CAAC,CAAC;YACpB,OAAO,CAAC,SAAS,CAAC,CAAC;QACrB,CAAC,CAAC;aACD,KAAK,CAAC,CAAC,IAAI,EAAE,EAAE;YACd,YAAY,CAAC,KAAK,CAAC,CAAC;YACpB,MAAM,CAAC,IAAI,CAAC,CAAC;QACf,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;AACL,CAAC;AAKD,KAAK,UAAU,sBAAsB,CACnC,OAA2B,EAC3B,OAAuB;IAIvB,MAAM,KAAK,GAAG;QACZ,kBAAkB,EAAE,OAAO,CAAC,MAAM;QAClC,mBAAmB,EAAE,CAAC;QACtB,kBAAkB,EAAE,CAAC;QACrB,kBAAkB,EAAE,CAAC;QACrB,gBAAgB,EAAE,CAAC;KACpB,CAAC;IAEF,OAAO;QACL,SAAS,EAAE,IAAI;QACf,IAAI,EAAE,OAAO,CAAC,IAAI;QAClB,MAAM,EAAE,OAAO,CAAC,MAAM;QACtB,KAAK;KACN,CAAC;AACJ,CAAC;AAOD,MAAM,UAAU,uBAAuB,CACrC,SAAwB;IAExB,OAAO;QACL,SAAS,EAAE,SAAS,CAAC,SAAS;QAC9B,IAAI,EAAE,SAAS,CAAC,IAAI;QACpB,MAAM,EAAE,SAAS,CAAC,MAAM;QACxB,KAAK,EAAE,SAAS,CAAC,KAAK;QACtB,GAAG,CAAC,SAAS,CAAC,gBAAgB,IAAI;YAChC,gBAAgB,EAAE,SAAS,CAAC,gBAAgB;SAC7C,CAAC;QACF,GAAG,CAAC,SAAS,CAAC,QAAQ,IAAI,EAAE,QAAQ,EAAE,SAAS,CAAC,QAAQ,EAAE,CAAC;KAC5D,CAAC;AACJ,CAAC;AAOD,MAAM,UAAU,uBAAuB,CAAC,IAA4B;IAClE,MAAM,QAAQ,GAAG;QACf,YAAY,EAAE,EAAE;QAChB,QAAQ,EAAE,EAAE;QACZ,UAAU,EAAE,EAAE;KACf,CAAC;IAEF,OAAO,QAAQ,CAAC,IAAI,CAAC,CAAC;AACxB,CAAC;AAKD,MAAM,UAAU,mBAAmB,CACjC,SAAiB,EACjB,MAAc,EACd,IAA4B;IAG5B,IAAI,IAAI,KAAK,cAAc,EAAE,CAAC;QAC5B,OAAO,SAAS,IAAI,MAAM,CAAC;IAC7B,CAAC;IAGD,IAAI,IAAI,KAAK,UAAU,EAAE,CAAC;QACxB,OAAO,SAAS,IAAI,MAAM,GAAG,GAAG,CAAC;IACnC,CAAC;IAGD,OAAO,SAAS,IAAI,MAAM,GAAG,IAAI,CAAC;AACpC,CAAC;AAOD,MAAM,UAAU,kBAAkB,CAAC,SAAwB;IACzD,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;QACzB,OAAO,CAAC,CAAC;IACX,CAAC;IAED,IAAI,SAAS,CAAC,MAAM,EAAE,CAAC;QACrB,OAAO,SAAS,CAAC,KAAK,CAAC,kBAAkB,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;IACxD,CAAC;IAGD,OAAO,SAAS,CAAC,KAAK,CAAC,kBAAkB,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AACzD,CAAC","sourcesContent":["// SPDX-License-Identifier: MIT\n// SPDX-FileCopyrightText: 2025 Oráculo Contributors\n\n/**\n * @module cli/diagnostico/handlers/auto-fix-handler\n * @description Handler modular para execução de auto-fix com validação de options\n * @see docs/REFACTOR-CLI-DIAGNOSTICAR.md - Sprint 2\n */\n\nimport { ExcecoesMessages } from '@core/messages/core/excecoes-messages.js';\nimport { log, MENSAGENS_AUTOFIX } from '@core/messages/index.js';\n\nimport type { AutoFixOptions, AutoFixResult, FileEntryWithAst } from '@';\n\n// Re-export para compatibilidade\nexport type { AutoFixOptions, AutoFixResult };\n\n  /* -------------------------- Handler Principal -------------------------- */\n\n/**\n * Executa o sistema de auto-fix com timeout e validação\n *\n * @param entries - Lista de arquivos para processar\n * @param options - Opções de execução\n * @returns Resultado da execução\n */\nexport async function executarAutoFix(\n  entries: FileEntryWithAst[],\n  options: AutoFixOptions,\n): Promise<AutoFixResult> {\n  try {\n    // Log de início (se não silencioso)\n    if (!options.silent) {\n      const modoLabel = {\n        conservative: 'conservador',\n        balanced: 'balanceado',\n        aggressive: 'agressivo',\n      }[options.mode];\n\n      if (options.dryRun) {\n        console.log(`${MENSAGENS_AUTOFIX.iniciando(modoLabel)}`);\n        console.log(MENSAGENS_AUTOFIX.dryRun);\n      } else {\n        console.log(MENSAGENS_AUTOFIX.iniciando(modoLabel));\n      }\n    }\n\n    // Executar com timeout\n    const timeout =\n      options.timeout ?? (process.env.VITEST === 'true' ? 1000 : 60000);\n    const resultado = await executarComTimeout(entries, options, timeout);\n\n    // Log de conclusão (se não silencioso)\n    if (!options.silent) {\n      const { correcoesAplicadas } = resultado.stats;\n\n      if (options.dryRun && resultado.stats.correcoesSugeridas > 0) {\n        console.log(\n          `Correções sugeridas: ${resultado.stats.correcoesSugeridas} em ${resultado.stats.arquivosAnalisados} arquivo(s)`,\n        );\n      } else if (correcoesAplicadas > 0) {\n        console.log(MENSAGENS_AUTOFIX.concluido(correcoesAplicadas, 0));\n      } else {\n        console.log(MENSAGENS_AUTOFIX.naoDisponivel);\n      }\n    }\n\n    return resultado;\n  } catch (erro) {\n    const mensagem = erro instanceof Error ? erro.message : String(erro);\n\n    if (!options.silent) {\n      log.aviso(\n        `${MENSAGENS_AUTOFIX.resultados.erroArquivo('', mensagem).split(':')[0]}: ${mensagem}`,\n      );\n    }\n\n    // Retornar resultado vazio em caso de erro\n    return {\n      executado: false,\n      mode: options.mode,\n      dryRun: options.dryRun,\n      stats: {\n        arquivosAnalisados: 0,\n        arquivosModificados: 0,\n        correcoesAplicadas: 0,\n        correcoesSugeridas: 0,\n        correcoesPuladas: 0,\n      },\n    };\n  }\n}\n\n/**\n * Executa auto-fix com proteção de timeout\n */\nasync function executarComTimeout(\n  entries: FileEntryWithAst[],\n  options: AutoFixOptions,\n  timeoutMs: number,\n): Promise<AutoFixResult> {\n  return new Promise((resolve, reject) => {\n    const timer = setTimeout(() => {\n      reject(new Error(ExcecoesMessages.autoFixTimeout(timeoutMs)));\n    }, timeoutMs);\n\n    executarAutoFixInterno(entries, options)\n      .then((resultado) => {\n        clearTimeout(timer);\n        resolve(resultado);\n      })\n      .catch((erro) => {\n        clearTimeout(timer);\n        reject(erro);\n      });\n  });\n}\n\n/**\n * Lógica interna de auto-fix\n */\nasync function executarAutoFixInterno(\n  entries: FileEntryWithAst[],\n  options: AutoFixOptions,\n): Promise<AutoFixResult> {\n  // NOTA: Integração real com sistema de auto-fix pendente de implementação\n  // Por enquanto, retornar resultado mock\n  const stats = {\n    arquivosAnalisados: entries.length,\n    arquivosModificados: 0,\n    correcoesAplicadas: 0,\n    correcoesSugeridas: 0,\n    correcoesPuladas: 0,\n  };\n\n  return {\n    executado: true,\n    mode: options.mode,\n    dryRun: options.dryRun,\n    stats,\n  };\n}\n\n  /* -------------------------- Formatação para JSON -------------------------- */\n\n/**\n * Formata resultado do auto-fix para saída JSON\n */\nexport function formatarAutoFixParaJson(\n  resultado: AutoFixResult,\n): Record<string, unknown> {\n  return {\n    executado: resultado.executado,\n    mode: resultado.mode,\n    dryRun: resultado.dryRun,\n    stats: resultado.stats,\n    ...(resultado.correcoesPorTipo && {\n      correcoesPorTipo: resultado.correcoesPorTipo,\n    }),\n    ...(resultado.detalhes && { detalhes: resultado.detalhes }),\n  };\n}\n\n  /* -------------------------- Helpers de Confiança -------------------------- */\n\n/**\n * Calcula limiar de confiança baseado no modo\n */\nexport function calcularLimiarConfianca(mode: AutoFixOptions['mode']): number {\n  const limiares = {\n    conservative: 90,\n    balanced: 75,\n    aggressive: 50,\n  };\n\n  return limiares[mode];\n}\n\n/**\n * Valida se uma correção deve ser aplicada\n */\nexport function deveAplicarCorrecao(\n  confianca: number,\n  limiar: number,\n  mode: AutoFixOptions['mode'],\n): boolean {\n  // Conservative: apenas alta confiança\n  if (mode === 'conservative') {\n    return confianca >= limiar;\n  }\n\n  // Balanced: permite ajuste fino\n  if (mode === 'balanced') {\n    return confianca >= limiar * 0.9;\n  }\n\n  // Aggressive: aceita confiança mais baixa\n  return confianca >= limiar * 0.75;\n}\n\n  /* -------------------------- Exit Code Helper -------------------------- */\n\n/**\n * Determina exit code baseado no resultado do auto-fix\n */\nexport function getExitCodeAutoFix(resultado: AutoFixResult): number {\n  if (!resultado.executado) {\n    return 1; // Erro na execução\n  }\n\n  if (resultado.dryRun) {\n    return resultado.stats.correcoesSugeridas > 0 ? 0 : 0; // Sempre 0 em dry-run\n  }\n\n  // Sucesso se aplicou correções ou não havia correções\n  return resultado.stats.correcoesAplicadas >= 0 ? 0 : 1;\n}\n"]}