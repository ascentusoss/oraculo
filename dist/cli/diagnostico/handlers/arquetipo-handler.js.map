{"version":3,"file":"arquetipo-handler.js","sourceRoot":"","sources":["../../../../src/cli/diagnostico/handlers/arquetipo-handler.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * üèóÔ∏è Arquetipo Handler\n *\n * Gerencia detec√ß√£o e an√°lise de estrutura do projeto\n * - Detecta arquetipos com timeout\n * - Identifica padr√µes de projeto\n * - Salva arquetipos personalizados\n * - Formata resultados\n */\n\nimport { detectarArquetipos } from '/detectores/detector-arquetipos.js';\nimport { config } from '/config/config.js';\nimport { CliArquetipoHandlerMessages } from '/messages/cli/cli-arquetipo-handler-messages.js';\nimport { MENSAGENS_ARQUETIPOS } from '/messages/core/diagnostico-messages.js';\nimport { log } from '/messages/index.js';\n\nimport type { ArquetipoOptions, ArquetipoResult, FileEntryWithAst } from '@';\n\n// Re-export para compatibilidade\nexport type { ArquetipoOptions, ArquetipoResult };\n\n/**\n * Timeout padr√£o para detec√ß√£o (em ms)\n */\nconst DEFAULT_TIMEOUT_MS = process.env.VITEST ? 1000 : 30000;\n\n/**\n * Executa detec√ß√£o de arquetipos com timeout\n */\nexport async function executarDeteccaoArquetipos(\n  entries: FileEntryWithAst[],\n  baseDir: string,\n  options: ArquetipoOptions,\n): Promise<ArquetipoResult> {\n  // Se desabilitado, retorna resultado vazio\n  if (!options.enabled) {\n    return {\n      executado: false,\n    };\n  }\n\n  try {\n    // Log de in√≠cio (se n√£o silencioso)\n    if (!options.silent) {\n      log.info(MENSAGENS_ARQUETIPOS.detectando);\n    }\n\n    // Preparar contexto\n    const ctx = {\n      arquivos: entries,\n      baseDir,\n    };\n\n    // Executar detec√ß√£o com timeout\n    const timeoutMs = options.timeout || DEFAULT_TIMEOUT_MS;\n    const resultado = await executarComTimeout(\n      detectarArquetipos(ctx, baseDir),\n      timeoutMs,\n    );\n\n    // Se timeout ou erro, retorna resultado parcial\n    if (!resultado) {\n      if (!options.silent) {\n        log.aviso(CliArquetipoHandlerMessages.timeoutDeteccao);\n      }\n      return {\n        executado: true,\n        erro: 'timeout',\n      };\n    }\n\n    // Processar resultado\n    const arquetipos = resultado.candidatos || [];\n    const principal = arquetipos.length > 0 ? arquetipos[0] : undefined; // Log de resultado (se n√£o silencioso)\n    if (!options.silent && principal) {\n      log.info(\n        MENSAGENS_ARQUETIPOS.identificado(principal.nome, principal.confidence),\n      );\n\n      if (arquetipos.length > 1) {\n        log.info(MENSAGENS_ARQUETIPOS.multiplos(arquetipos.length));\n      }\n    }\n\n    // Salvar se solicitado\n    let salvo = false;\n    if (options.salvar && resultado) {\n      salvo = await salvarArquetipo(resultado, baseDir, options.silent);\n    }\n\n    return {\n      executado: true,\n      arquetipos: arquetipos.map((a) => ({\n        tipo: a.nome,\n        confianca: a.confidence,\n        caracteristicas: a.matchedRequired || [],\n      })),\n      principal: principal\n        ? {\n            tipo: principal.nome,\n            confianca: principal.confidence,\n          }\n        : undefined,\n      salvo,\n    };\n  } catch (erro) {\n    const mensagem = erro instanceof Error ? erro.message : String(erro);\n\n    if (!options.silent) {\n      log.aviso(CliArquetipoHandlerMessages.erroDeteccao(mensagem));\n    }\n\n    // Em DEV_MODE, log mais detalhado\n    if (config.DEV_MODE) {\n      console.error(CliArquetipoHandlerMessages.devErroPrefixo, erro);\n    }\n\n    return {\n      executado: true,\n      erro: mensagem,\n    };\n  }\n}\n\n/**\n * Executa fun√ß√£o com timeout\n */\nasync function executarComTimeout<T>(\n  promise: Promise<T>,\n  timeoutMs: number,\n): Promise<T | undefined> {\n  try {\n    const timeoutPromise = new Promise<undefined>((resolve) =>\n      setTimeout(() => resolve(undefined), timeoutMs),\n    );\n\n    return (await Promise.race([promise, timeoutPromise])) as T | undefined;\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Salva arquetipo personalizado\n */\nasync function salvarArquetipo(\n  resultado: Awaited<ReturnType<typeof detectarArquetipos>>,\n  baseDir: string,\n  silent?: boolean,\n): Promise<boolean> {\n  try {\n    if (!silent) {\n      log.info(MENSAGENS_ARQUETIPOS.salvando);\n    }\n\n    // Importa√ß√£o din√¢mica para evitar depend√™ncias circulares\n    const fs = await import('node:fs/promises');\n    const path = await import('node:path');\n\n    // Preparar dados do arquetipo\n    const arquetipo = {\n      timestamp: new Date().toISOString(),\n      projeto: path.basename(baseDir),\n      arquetipos: resultado.candidatos,\n      baseline: resultado.baseline,\n      drift: resultado.drift,\n    };\n\n    // Salvar em arquivo\n    const outputPath = path.join(baseDir, 'oraculo.repo.arquetipo.json');\n    await fs.writeFile(outputPath, JSON.stringify(arquetipo, null, 2), 'utf-8');\n\n    if (!silent) {\n      log.sucesso(MENSAGENS_ARQUETIPOS.salvo(outputPath));\n    }\n\n    return true;\n  } catch (erro) {\n    const mensagem = erro instanceof Error ? erro.message : String(erro);\n\n    if (!silent) {\n      log.aviso(CliArquetipoHandlerMessages.falhaSalvar(mensagem));\n    }\n\n    return false;\n  }\n}\n\n/**\n * Formata resultado de arquetipos para JSON\n */\nexport function formatarArquetiposParaJson(\n  result: ArquetipoResult,\n): Record<string, unknown> {\n  if (!result.executado) {\n    return {\n      executado: false,\n    };\n  }\n\n  if (result.erro) {\n    return {\n      executado: true,\n      erro: result.erro,\n    };\n  }\n\n  return {\n    executado: true,\n    arquetipos: result.arquetipos || [],\n    principal: result.principal || null,\n    salvo: result.salvo || false,\n  };\n}\n\n/**\n * Gera sugest√µes baseadas no arquetipo detectado\n */\nexport function gerarSugestoesArquetipo(result: ArquetipoResult): string[] {\n  const sugestoes: string[] = [];\n\n  if (!result.executado || !result.principal) {\n    return sugestoes;\n  }\n\n  const { tipo, confianca } = result.principal;\n\n  // Sugest√µes baseadas no tipo de projeto\n  switch (tipo.toLowerCase()) {\n    case 'monorepo':\n      sugestoes.push(\n        'üí° Monorepo detectado: considere usar filtros por workspace',\n      );\n      sugestoes.push(\n        'üí° Use --include packages/* para analisar workspaces espec√≠ficos',\n      );\n      break;\n\n    case 'biblioteca':\n    case 'library':\n      sugestoes.push(\n        'üí° Biblioteca detectada: foque em exports p√∫blicos e documenta√ß√£o',\n      );\n      sugestoes.push('üí° Use --guardian para verificar API p√∫blica');\n      break;\n\n    case 'cli':\n    case 'cli-tool':\n      sugestoes.push('üí° CLI detectado: priorize testes de comandos e flags');\n      break;\n\n    case 'api':\n    case 'api-rest':\n    case 'api-server':\n      sugestoes.push('üí° API detectada: foque em endpoints e contratos');\n      sugestoes.push('üí° Considere testes de integra√ß√£o para rotas');\n      break;\n\n    case 'frontend':\n    case 'web-app':\n      sugestoes.push(\n        'üí° Frontend detectado: priorize componentes e state management',\n      );\n      break;\n  }\n\n  // Sugest√£o baseada em confian√ßa\n  if (confianca < 70) {\n    sugestoes.push(\n      '‚ö†Ô∏è  Confian√ßa baixa na detec√ß√£o: estrutura pode ser h√≠brida',\n    );\n    sugestoes.push(\n      'üí° Use --criar-arquetipo --salvar-arquetipo para personalizar',\n    );\n  }\n\n  return sugestoes;\n}\n"]}