{"version":3,"file":"reestruturacao-exporter.js","sourceRoot":"","sources":["../../../src/cli/handlers/reestruturacao-exporter.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * Handler para exportação de relatórios de reestruturação\n * Consolida lógica duplicada de geração de relatórios Markdown e JSON\n */\n\nimport { promises as fs } from 'node:fs';\nimport path from 'node:path';\n\nimport { config } from '@core/config/config.js';\nimport { CliExportersMessages } from '@core/messages/cli/cli-exporters-messages.js';\nimport { log } from '@core/messages/index.js';\nimport {\n  gerarRelatorioReestruturarJson,\n  gerarRelatorioReestruturarMarkdown,\n} from '@relatorios/relatorio-reestruturar.js';\n\nimport type {\n  MovimentoEstrutural,\n  ReestruturacaoExportOptions,\n  ReestruturacaoExportResult,\n} from '@';\n\n// Re-export para compatibilidade\nexport type { ReestruturacaoExportOptions, ReestruturacaoExportResult };\n\n/**\n * Normaliza movimentos para formato padrão MovimentoEstrutural\n */\nfunction normalizarMovimentos(\n  movimentos: ReestruturacaoExportOptions['movimentos'],\n): MovimentoEstrutural[] {\n  return movimentos.map((m) => {\n    // Se tem 'de' e 'para', já está no formato correto (PlanoMoverItem)\n    if ('de' in m && 'para' in m) {\n      return { de: m.de, para: m.para };\n    }\n    // Se tem 'atual' e 'ideal', é MapaMoveItem - converter\n    if ('atual' in m && 'ideal' in m) {\n      return { de: m.atual, para: m.ideal ?? m.atual };\n    }\n    // Fallback: retornar objeto vazio (não deve acontecer com tipos corretos)\n    return { de: '', para: '' };\n  });\n}\n\n/**\n * Exporta relatórios de reestruturação (Markdown e JSON)\n *\n * Centraliza a lógica de:\n * - Criação de diretório de relatórios\n * - Geração de timestamp único\n * - Exportação em ambos os formatos\n * - Tratamento de erros\n *\n * @param options - Opções de exportação\n * @returns Caminhos dos arquivos gerados ou null em caso de erro\n */\nexport async function exportarRelatoriosReestruturacao(\n  options: ReestruturacaoExportOptions,\n): Promise<ReestruturacaoExportResult | null> {\n  if (!config.REPORT_EXPORT_ENABLED) {\n    return null;\n  }\n\n  try {\n    const { baseDir, movimentos, simulado, origem, preset, conflitos } =\n      options;\n\n    // Determinar diretório de saída\n    const dir =\n      typeof config.REPORT_OUTPUT_DIR === 'string'\n        ? config.REPORT_OUTPUT_DIR\n        : path.join(baseDir, 'relatorios');\n\n    // Criar diretório se não existir\n    await fs.mkdir(dir, { recursive: true });\n\n    // Gerar timestamp único para os arquivos\n    const ts = new Date().toISOString().replace(/[:.]/g, '-');\n    const nomeBase = `oraculo-reestruturacao-${ts}`;\n\n    // Normalizar movimentos para formato padrão\n    const movimentosNormalizados = normalizarMovimentos(movimentos);\n\n    // Gerar relatório Markdown\n    const caminhoMd = path.join(dir, `${nomeBase}.md`);\n    await gerarRelatorioReestruturarMarkdown(\n      caminhoMd,\n      movimentosNormalizados,\n      {\n        simulado,\n        origem,\n        preset,\n        conflitos,\n      },\n    );\n\n    // Gerar relatório JSON\n    const caminhoJson = path.join(dir, `${nomeBase}.json`);\n    await gerarRelatorioReestruturarJson(caminhoJson, movimentosNormalizados, {\n      simulado,\n      origem,\n      preset,\n      conflitos,\n    });\n\n    // Log de sucesso\n    const modo = simulado ? '(dry-run) ' : '';\n    log.sucesso(\n      CliExportersMessages.reestruturacao.relatoriosExportados(modo, dir),\n    );\n\n    return {\n      markdown: caminhoMd,\n      json: caminhoJson,\n      dir,\n    };\n  } catch (error) {\n    const modo = options.simulado ? '(dry-run) ' : '';\n    log.erro(\n      CliExportersMessages.reestruturacao.falhaExportar(\n        modo,\n        (error as Error).message,\n      ),\n    );\n    return null;\n  }\n}\n"]}