{"version":3,"file":"file-registry.js","sourceRoot":"","sources":["../../../src/core/registry/file-registry.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n *  Registry centralizado para operações de leitura/escrita de arquivos JSON\n *\n * Este módulo fornece uma camada de abstração sobre a persistência,\n * gerenciando migrações automáticas de arquivos legados e garantindo\n * que todos os arquivos sejam salvos nos locais corretos.\n *\n * Features:\n * - Migração automática de arquivos legados\n * - Validação de integridade de JSONs\n * - Logging de operações de I/O\n * - Fallback para configurações seguras\n */\nimport { promises as fs } from 'node:fs';\nimport path from 'node:path';\n\nimport { ExcecoesMessages } from '/messages/core/excecoes-messages.js';\n\nimport type { MigrationResult } from '@';\n\nimport { log } from '../messages/log/log.js';\nimport {\n  MIGRATION_MAP,\n  ORACULO_DIRS,\n  ORACULO_FILES,\n  type OraculoFilePath,\n} from './paths.js';\n\n/**\n * Opções para operações de leitura\n */\ninterface ReadOptions<T> {\n  /** Valor padrão se arquivo não existir */\n  default?: T;\n  /** Tentar migrar de arquivo legado automaticamente */\n  migrate?: boolean;\n  /** Validar estrutura do JSON */\n  validate?: (data: unknown) => data is T;\n}\n\n/**\n * Opções para operações de escrita\n */\ninterface WriteOptions {\n  /** Criar diretórios pai se não existirem */\n  createDirs?: boolean;\n  /** Fazer backup antes de sobrescrever */\n  backup?: boolean;\n  /** Pretty print JSON */\n  pretty?: boolean;\n}\n\n/**\n * Verifica se arquivo existe\n */\nasync function fileExists(filePath: string): Promise<boolean> {\n  try {\n    await fs.access(filePath);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Cria diretórios pai se não existirem\n */\nasync function ensureDir(filePath: string): Promise<void> {\n  const dir = path.dirname(filePath);\n  await fs.mkdir(dir, { recursive: true });\n}\n\n/**\n * Tenta migrar arquivo legado para novo local\n */\nasync function tryMigrate(targetPath: string): Promise<MigrationResult> {\n  const legacyPath = Object.entries(MIGRATION_MAP).find(\n    ([_, target]) => target === targetPath,\n  )?.[0];\n\n  if (!legacyPath) {\n    return { migrated: false };\n  }\n\n  const legacyExists = await fileExists(legacyPath);\n  if (!legacyExists) {\n    return { migrated: false };\n  }\n\n  try {\n    // Ler arquivo legado\n    const content = await fs.readFile(legacyPath, 'utf-8');\n\n    // Garantir diretório de destino\n    await ensureDir(targetPath);\n\n    // Escrever no novo local\n    await fs.writeFile(targetPath, content, 'utf-8');\n\n    // Renomear arquivo legado (não deletar para segurança)\n    const backupPath = `${legacyPath}.migrated`;\n    await fs.rename(legacyPath, backupPath);\n\n    log.info(\n      `Migração automática: ${path.basename(legacyPath)} → ${path.basename(targetPath)}`,\n    );\n\n    return {\n      migrated: true,\n      from: legacyPath,\n      to: targetPath,\n    };\n  } catch (erro) {\n    log.aviso(`Falha na migração de ${legacyPath}: ${(erro as Error).message}`);\n    return { migrated: false };\n  }\n}\n\n/**\n * Lê arquivo JSON do registry\n *\n *  filePath Caminho do arquivo (use ORACULO_FILES.*)\n *  options Opções de leitura\n *  Conteúdo parseado do JSON\n *\n * \n * ```ts\n * const config = await readJSON(ORACULO_FILES.CONFIG, {\n *   default: {}\n * });\n * ```\n */\nexport async function readJSON<T = unknown>(\n  filePath: OraculoFilePath | string,\n  options: ReadOptions<T> = {},\n): Promise<T> {\n  const { default: defaultValue, migrate = true, validate } = options;\n\n  try {\n    // Tentar migração se habilitado\n    if (migrate) {\n      const migration = await tryMigrate(filePath);\n      if (migration.migrated && migration.to) {\n        // Usar arquivo migrado\n        filePath = migration.to;\n      }\n    }\n\n    // Verificar existência\n    const exists = await fileExists(filePath);\n    if (!exists) {\n      if (defaultValue !== undefined) {\n        return defaultValue;\n      }\n      throw new Error(ExcecoesMessages.arquivoNaoEncontrado(String(filePath)));\n    }\n\n    // Ler e parsear\n    const content = await fs.readFile(filePath, 'utf-8');\n    const parsed = JSON.parse(content) as T;\n\n    // Validar se fornecido\n    if (validate && !validate(parsed)) {\n      throw new Error(ExcecoesMessages.validacaoFalhouPara(String(filePath)));\n    }\n\n    return parsed;\n  } catch (erro) {\n    if (defaultValue !== undefined) {\n      return defaultValue;\n    }\n    throw new Error(\n      ExcecoesMessages.erroAoLer(String(filePath), (erro as Error).message),\n    );\n  }\n}\n\n/**\n * Escreve arquivo JSON no registry\n *\n *  filePath Caminho do arquivo (use ORACULO_FILES.*)\n *  data Dados a serem salvos\n *  options Opções de escrita\n *\n * \n * ```ts\n * await writeJSON(ORACULO_FILES.GUARDIAN_BASELINE, snapshot, {\n *   createDirs: true,\n *   backup: true\n * });\n * ```\n */\nexport async function writeJSON<T = unknown>(\n  filePath: OraculoFilePath | string,\n  data: T,\n  options: WriteOptions = {},\n): Promise<void> {\n  const { createDirs = true, backup = false, pretty = true } = options;\n\n  try {\n    // Criar diretórios se necessário\n    if (createDirs) {\n      await ensureDir(filePath);\n    }\n\n    // Fazer backup se solicitado\n    if (backup && (await fileExists(filePath))) {\n      const backupPath = `${filePath}.backup`;\n      await fs.copyFile(filePath, backupPath);\n    }\n\n    // Serializar JSON\n    const content = pretty\n      ? JSON.stringify(data, null, 2)\n      : JSON.stringify(data);\n\n    // Escrever arquivo\n    await fs.writeFile(filePath, content, 'utf-8');\n  } catch (erro) {\n    throw new Error(\n      ExcecoesMessages.erroAoEscrever(\n        String(filePath),\n        (erro as Error).message,\n      ),\n    );\n  }\n}\n\n/**\n * Deleta arquivo do registry\n *\n *  filePath Caminho do arquivo (use ORACULO_FILES.*)\n *  options Opções de deleção\n */\nexport async function deleteJSON(\n  filePath: OraculoFilePath | string,\n  options: { backup?: boolean } = {},\n): Promise<void> {\n  const { backup = true } = options;\n\n  try {\n    const exists = await fileExists(filePath);\n    if (!exists) {\n      return; // Já deletado\n    }\n\n    if (backup) {\n      const backupPath = `${filePath}.deleted`;\n      await fs.rename(filePath, backupPath);\n    } else {\n      await fs.unlink(filePath);\n    }\n  } catch (erro) {\n    throw new Error(\n      ExcecoesMessages.erroAoDeletar(String(filePath), (erro as Error).message),\n    );\n  }\n}\n\n/**\n * Lista todos os arquivos JSON em um diretório do registry\n *\n *  dirPath Caminho do diretório (use ORACULO_DIRS.*)\n *  Lista de caminhos completos\n */\nexport async function listJSONFiles(dirPath: string): Promise<string[]> {\n  try {\n    const exists = await fileExists(dirPath);\n    if (!exists) {\n      return [];\n    }\n\n    const entries = await fs.readdir(dirPath, { withFileTypes: true });\n    const jsonFiles = entries\n      .filter((entry) => entry.isFile() && entry.name.endsWith('.json'))\n      .map((entry) => path.join(dirPath, entry.name));\n\n    return jsonFiles;\n  } catch (erro) {\n    log.aviso(\n      `Erro ao listar arquivos em ${dirPath}: ${(erro as Error).message}`,\n    );\n    return [];\n  }\n}\n\n/**\n * Exporta funções auxiliares para compatibilidade com código existente\n */\nexport const FileRegistry = {\n  read: readJSON,\n  write: writeJSON,\n  delete: deleteJSON,\n  list: listJSONFiles,\n  paths: ORACULO_FILES,\n  dirs: ORACULO_DIRS,\n} as const;\n"]}