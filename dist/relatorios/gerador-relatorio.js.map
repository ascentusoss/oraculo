{"version":3,"file":"gerador-relatorio.js","sourceRoot":"","sources":["../../src/relatorios/gerador-relatorio.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// Gerador de relatórios: Markdown e JSON\nimport {\n  gerarHeaderRelatorio,\n  gerarSecaoGuardian,\n  gerarTabelaOcorrencias,\n  gerarTabelaResumoTipos,\n  RelatorioMessages,\n} from '/messages/index.js';\n\nimport type {\n  GeradorMarkdownOptions,\n  Ocorrencia,\n  ResultadoInquisicaoCompleto,\n} from '@';\n\nexport async function gerarRelatorioMarkdown(\n  resultado: ResultadoInquisicaoCompleto,\n  outputPath: string,\n  modoBrief = false,\n  options?: GeradorMarkdownOptions,\n): Promise<void> {\n  const {\n    totalArquivos = 0,\n    ocorrencias = [],\n    guardian,\n    timestamp = Date.now(),\n    duracaoMs = 0,\n  } = (resultado || {}) as ResultadoInquisicaoCompleto;\n\n  const dataISO = new Date(timestamp).toISOString();\n\n  // Se modo brief, usar filtro inteligente\n  if (modoBrief) {\n    const { processarRelatorioResumo, gerarRelatorioMarkdownResumo } =\n      await import('/filtro-inteligente.js');\n    const relatorioResumo = processarRelatorioResumo(ocorrencias);\n    await gerarRelatorioMarkdownResumo(relatorioResumo, outputPath);\n    return;\n  }\n\n  const ocorrenciasOrdenadas: Ocorrencia[] = [...ocorrencias].sort((a, b) => {\n    const ra = String(a.relPath ?? '');\n    const rb = String(b.relPath ?? '');\n    const cmp = ra.localeCompare(rb);\n    if (cmp !== 0) return cmp;\n    const la = typeof a.linha === 'number' ? a.linha : Number.MAX_SAFE_INTEGER;\n    const lb = typeof b.linha === 'number' ? b.linha : Number.MAX_SAFE_INTEGER;\n    return la - lb;\n  });\n\n  // Extrair dados do Guardian\n  const guardianData =\n    guardian && typeof guardian === 'object'\n      ? {\n          status:\n            'status' in guardian\n              ? String((guardian as Record<string, unknown>).status)\n              : 'não executada',\n          timestamp:\n            'timestamp' in guardian\n              ? String((guardian as Record<string, unknown>).timestamp)\n              : '—',\n          totalArquivos:\n            'totalArquivos' in guardian\n              ? String((guardian as Record<string, unknown>).totalArquivos)\n              : '—',\n        }\n      : {\n          status: 'não executada',\n          timestamp: '—',\n          totalArquivos: '—',\n        };\n\n  // Montar o header usando template centralizado\n  const lines: string[] = [];\n\n  lines.push(\n    ...gerarHeaderRelatorio({\n      dataISO,\n      duracao: duracaoMs,\n      totalArquivos,\n      totalOcorrencias: ocorrencias.length,\n    }),\n  );\n\n  // Se houver manifest, adiciona link e sumário rápido\n  if (options && options.manifestFile && options.relatoriosDir) {\n    const relPath = options.manifestFile;\n    lines.push(\n      `**${RelatorioMessages.principal.secoes.metadados.arquivoManifest}:** \\`${relPath}\\`  `,\n    );\n    lines.push('');\n    lines.push(\n      `> ${RelatorioMessages.principal.secoes.metadados.notaManifest}`,\n    );\n    lines.push('');\n    lines.push('---');\n    lines.push('');\n  }\n\n  // Seção Guardian usando template\n  lines.push(...gerarSecaoGuardian(guardianData));\n\n  // Sumário das ocorrências por tipo usando template\n  const tiposCount: Record<string, number> = {};\n  for (const ocorrencia of ocorrencias) {\n    const tipo =\n      (ocorrencia && (ocorrencia as Ocorrencia).tipo) || 'desconhecido';\n    tiposCount[String(tipo)] = (tiposCount[String(tipo)] || 0) + 1;\n  }\n\n  lines.push(...gerarTabelaResumoTipos(tiposCount, 10));\n\n  // Tabela com ocorrências usando template\n  lines.push('---');\n  lines.push('');\n  lines.push(\n    `## ${RelatorioMessages.principal.secoes.ocorrencias.titulo} (amostra)`,\n  );\n  lines.push('');\n\n  const AMOSTRA_MAX = 2000;\n  const sample = ocorrenciasOrdenadas.slice(0, AMOSTRA_MAX);\n\n  lines.push(...gerarTabelaOcorrencias(sample));\n\n  if (ocorrenciasOrdenadas.length > AMOSTRA_MAX) {\n    lines.push('');\n    lines.push(\n      `> Mostrando apenas ${AMOSTRA_MAX} ocorrências. Para ver todas, consulte os shards listados no manifest.`,\n    );\n  }\n\n  const { salvarEstado } = await import('/persistence/persistencia.js');\n  await salvarEstado(outputPath, lines.join('\\n'));\n}\n\nexport async function gerarRelatorioJson(\n  resultado: ResultadoInquisicaoCompleto,\n  outputPath: string,\n): Promise<void> {\n  // Importar sistema de versionamento\n  const { criarRelatorioComVersao } = await import('/schema/version.js');\n\n  // Criar relatório versionado (mantemos metadados, mas salvamos os dados brutos para compatibilidade)\n  const relatorioVersionado = criarRelatorioComVersao(\n    resultado,\n    undefined,\n    'Relatório completo de diagnóstico do Oráculo',\n  );\n\n  const { salvarEstado } = await import('/persistence/persistencia.js');\n  await salvarEstado(outputPath, relatorioVersionado.dados ?? resultado);\n}\n"]}