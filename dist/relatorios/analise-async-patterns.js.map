{"version":3,"file":"analise-async-patterns.js","sourceRoot":"","sources":["../../src/relatorios/analise-async-patterns.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n *  An√°lise de padr√µes async/await\n *\n * P√≥s-processador de relat√≥rios que analisa ocorr√™ncias `unhandled-async`,\n * agrupa por criticidade e gera recomenda√ß√µes priorizadas.\n *\n * Migrado de: scripts/analisar-async-patterns.mjs\n * Data: 2025-11-02\n */\n\nimport path from 'node:path';\n\nimport { log, MENSAGENS_RELATORIOS_ANALISE } from '/messages/index.js';\nimport { salvarEstado } from '/persistence/persistencia.js';\n\nimport type { Ocorrencia } from '@';\n\nimport type {\n  AsyncAnalysisOptions,\n  AsyncAnalysisReport,\n  AsyncArquivoRanqueado,\n  AsyncCategoria,\n  AsyncCategoriaStats,\n  AsyncIssuesArquivo,\n} from '../types/relatorios/async-analysis.js';\n\n/**\n * Categoriza arquivo baseado no path\n */\nfunction categorizarArquivo(relPath: string): AsyncCategoria {\n  if (relPath.includes('cli/')) return 'cli';\n  if (relPath.includes('analistas/')) return 'analistas';\n  if (relPath.includes('core/') || relPath.includes('nucleo/')) return 'core';\n  if (relPath.includes('guardian/')) return 'guardian';\n  if (relPath.includes('auto/') || relPath.includes('zeladores/'))\n    return 'auto';\n  return 'outros';\n}\n\n/**\n * Extrai total de promises de uma mensagem\n */\nfunction extrairTotalPromises(mensagem: string): number {\n  const match = mensagem.match(/\\((\\d+) mais\\)/);\n  if (match) {\n    return parseInt(match[1], 10) + 1;\n  }\n  return 1;\n}\n\n/**\n * Agrupa ocorr√™ncias por arquivo\n */\nfunction agruparPorArquivo(\n  ocorrencias: Ocorrencia[],\n): Map<string, AsyncIssuesArquivo> {\n  const porArquivo = new Map<string, AsyncIssuesArquivo>();\n\n  for (const issue of ocorrencias) {\n    const arquivo = issue.relPath;\n    if (!porArquivo.has(arquivo)) {\n      porArquivo.set(arquivo, {\n        ocorrencias: [],\n        nivel: (issue.nivel || 'info') as 'erro' | 'aviso' | 'info',\n        total: 0,\n      });\n    }\n    const info = porArquivo.get(arquivo);\n    if (!info) continue;\n    info.ocorrencias.push({\n      linha: issue.linha,\n      mensagem: issue.mensagem,\n      nivel: (issue.nivel || 'info') as 'erro' | 'aviso' | 'info',\n    });\n    info.total += extrairTotalPromises(issue.mensagem);\n  }\n\n  return porArquivo;\n}\n\n/**\n * Analisa padr√µes async/await de um relat√≥rio\n */\nexport async function analisarAsyncPatterns(\n  ocorrencias: Ocorrencia[],\n  options: AsyncAnalysisOptions = {},\n): Promise<AsyncAnalysisReport> {\n  const topN = options.topN || 20;\n\n  // Filtrar apenas unhandled-async\n  const asyncIssues = ocorrencias.filter(\n    (o) => o.mensagem && o.mensagem.includes('unhandled-async'),\n  );\n\n  log.info(MENSAGENS_RELATORIOS_ANALISE.asyncPatterns.titulo);\n  log.info(`Total de ocorr√™ncias unhandled-async: ${asyncIssues.length}`);\n\n  // Agrupar por arquivo\n  const porArquivo = agruparPorArquivo(asyncIssues);\n\n  // Ordenar por total (decrescente)\n  const arquivosOrdenados = Array.from(porArquivo.entries())\n    .map(\n      ([arquivo, info]): AsyncArquivoRanqueado => ({\n        arquivo,\n        total: info.total,\n        nivel: (info.nivel || 'info') as 'erro' | 'aviso' | 'info',\n      }),\n    )\n    .sort((a, b) => b.total - a.total);\n\n  // Top arquivos\n  log.info(\n    `\\nüî¥ TOP ${Math.min(topN, arquivosOrdenados.length)} Arquivos com Mais Promises N√£o Tratadas:\\n`,\n  );\n\n  for (let i = 0; i < Math.min(topN, arquivosOrdenados.length); i++) {\n    const { arquivo, total, nivel } = arquivosOrdenados[i];\n    const nivelIcon = nivel === 'erro' ? 'üî¥' : nivel === 'aviso' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';\n    log.info(`${i + 1}. ${nivelIcon} ${arquivo}`);\n    log.info(`   ‚îî‚îÄ ${total} promise(s) sem tratamento de erro`);\n    log.info(`   ‚îî‚îÄ Prioridade: ${nivel.toUpperCase()}\\n`);\n  }\n\n  // Estat√≠sticas por categoria\n  const categorias: Record<AsyncCategoria, AsyncCategoriaStats> = {\n    cli: { totalArquivos: 0, totalPromises: 0 },\n    analistas: { totalArquivos: 0, totalPromises: 0 },\n    core: { totalArquivos: 0, totalPromises: 0 },\n    guardian: { totalArquivos: 0, totalPromises: 0 },\n    auto: { totalArquivos: 0, totalPromises: 0 },\n    outros: { totalArquivos: 0, totalPromises: 0 },\n  };\n\n  for (const { arquivo, total } of arquivosOrdenados) {\n    const categoria = categorizarArquivo(arquivo);\n    categorias[categoria].totalArquivos++;\n    categorias[categoria].totalPromises += total;\n  }\n\n  log.info(`\\nüìÇ Distribui√ß√£o por Categoria:\\n`);\n  for (const [cat, stats] of Object.entries(categorias)) {\n    if (stats.totalArquivos > 0) {\n      log.info(\n        `  ${cat.toUpperCase()}: ${stats.totalArquivos} arquivos, ${stats.totalPromises} promises`,\n      );\n    }\n  }\n\n  // Recomenda√ß√µes\n  if (options.includeRecomendacoes !== false) {\n    const criticos = arquivosOrdenados.filter((a) => a.nivel === 'erro');\n    const altos = arquivosOrdenados.filter((a) => a.nivel === 'aviso');\n\n    log.info(MENSAGENS_RELATORIOS_ANALISE.asyncPatterns.recomendacoes);\n\n    if (criticos.length > 0) {\n      log.info(MENSAGENS_RELATORIOS_ANALISE.asyncPatterns.critico);\n      for (const { arquivo } of criticos.slice(0, 5)) {\n        log.info(`   - ${arquivo}`);\n      }\n    }\n\n    if (altos.length > 0) {\n      log.info(MENSAGENS_RELATORIOS_ANALISE.asyncPatterns.alto);\n      for (const { arquivo } of altos.slice(0, 10)) {\n        log.info(`   - ${arquivo}`);\n      }\n    }\n\n    log.info(`\\nüìã Pr√≥ximos Passos:\\n`);\n    log.info('1. Revisar arquivos CR√çTICOS e adicionar .catch() ou try/catch');\n    log.info('2. Para arquivos com muitas ocorr√™ncias, considerar refatora√ß√£o');\n    log.info('3. Validar se promises t√™m tratamento em n√≠vel superior');\n    log.info('4. Adicionar testes para garantir robustez\\n');\n  }\n\n  // Montar relat√≥rio\n  const report: AsyncAnalysisReport = {\n    timestamp: new Date().toISOString(),\n    totalIssues: asyncIssues.length,\n    totalFiles: porArquivo.size,\n    topFiles: arquivosOrdenados.slice(0, topN),\n    categorias,\n  };\n\n  if (options.includeRecomendacoes !== false) {\n    const criticos = arquivosOrdenados.filter((a) => a.nivel === 'erro');\n    const altos = arquivosOrdenados.filter((a) => a.nivel === 'aviso');\n\n    report.recomendacoes = {\n      criticos: criticos.slice(0, 5).map((a) => a.arquivo),\n      altos: altos.slice(0, 10).map((a) => a.arquivo),\n      proximosPassos: [\n        'Revisar arquivos CR√çTICOS e adicionar .catch() ou try/catch',\n        'Para arquivos com muitas ocorr√™ncias, considerar refatora√ß√£o',\n        'Validar se promises t√™m tratamento em n√≠vel superior',\n        'Adicionar testes para garantir robustez',\n      ],\n    };\n  }\n\n  return report;\n}\n\n/**\n * Salva relat√≥rio de an√°lise async\n */\nexport async function salvarRelatorioAsync(\n  report: AsyncAnalysisReport,\n  outputPath: string,\n): Promise<void> {\n  await salvarEstado(outputPath, report);\n  log.sucesso(MENSAGENS_RELATORIOS_ANALISE.asyncPatterns.salvo(outputPath));\n}\n\n/**\n * Executa an√°lise completa e salva relat√≥rio\n */\nexport async function executarAnaliseAsync(\n  ocorrencias: Ocorrencia[],\n  baseDir: string,\n  options: AsyncAnalysisOptions = {},\n): Promise<void> {\n  const report = await analisarAsyncPatterns(ocorrencias, options);\n\n  const reportPath = path.join(\n    baseDir,\n    'relatorios',\n    'async-analysis-report.json',\n  );\n  await salvarRelatorioAsync(report, reportPath);\n}\n"]}