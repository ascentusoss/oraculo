{"version":3,"file":"memory.js","sourceRoot":"","sources":["../../src/shared/memory.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport { mkdir, readFile, writeFile } from 'node:fs/promises';\nimport { dirname, join } from 'node:path';\n\nimport type { MemoryMessage, OraculoContextState, OraculoRunRecord } from '@';\n\n// Re-exporta para compatibilidade com código existente\nexport type { MemoryMessage, OraculoContextState, OraculoRunRecord };\n\nexport class ConversationMemory {\n  private history: MemoryMessage[] = [];\n  constructor(\n    private maxHistory = 10,\n    private persistPath?: string,\n  ) {}\n\n  async init(): Promise<void> {\n    if (!this.persistPath) return;\n    try {\n      const raw = await readFile(this.persistPath, 'utf-8');\n      this.history = JSON.parse(raw);\n    } catch {\n      this.history = [];\n    }\n  }\n\n  async addMessage(message: MemoryMessage): Promise<void> {\n    this.history.push(message);\n    if (this.history.length > this.maxHistory * 2) {\n      this.history = this.history.slice(-this.maxHistory * 2);\n    }\n    await this.persist();\n  }\n\n  getContext(lastN?: number): MemoryMessage[] {\n    if (lastN) return this.history.slice(-lastN);\n    return [...this.history];\n  }\n\n  getSummary(): {\n    // @oraculo-disable: tipo-literal-inline-complexo\n    totalMessages: number;\n    userMessages: number;\n    assistantMessages: number;\n    firstMessage?: string;\n    lastMessage?: string;\n  } {\n    return {\n      totalMessages: this.history.length,\n      userMessages: this.history.filter((m) => m.role === 'user').length,\n      assistantMessages: this.history.filter((m) => m.role === 'assistant')\n        .length,\n      firstMessage: this.history[0]?.timestamp,\n      lastMessage: this.history[this.history.length - 1]?.timestamp,\n    };\n  }\n\n  async clear(): Promise<void> {\n    this.history = [];\n    await this.persist();\n  }\n\n  private async persist(): Promise<void> {\n    if (!this.persistPath) return;\n    try {\n      await mkdir(dirname(this.persistPath), { recursive: true });\n      await writeFile(\n        this.persistPath,\n        JSON.stringify(this.history, null, 2),\n        'utf-8',\n      );\n    } catch {\n      // ignore persist errors\n    }\n  }\n}\n\nexport class OraculoContextMemory {\n  private state: OraculoContextState = {\n    schemaVersion: 1,\n    lastRuns: [],\n    preferences: {},\n  };\n\n  constructor(\n    private maxRuns = 20,\n    private persistPath?: string,\n  ) {}\n\n  async init(): Promise<void> {\n    if (!this.persistPath) return;\n    try {\n      const raw = await readFile(this.persistPath, 'utf-8');\n      const parsed = JSON.parse(raw) as Partial<OraculoContextState>;\n      if (parsed && parsed.schemaVersion === 1) {\n        this.state = {\n          // @oraculo-disable: tipo-literal-inline-complexo\n          schemaVersion: 1,\n          lastRuns: Array.isArray(parsed.lastRuns)\n            ? (parsed.lastRuns as OraculoRunRecord[])\n            : [],\n          preferences:\n            parsed.preferences && typeof parsed.preferences === 'object'\n              ? (parsed.preferences as Record<string, unknown>)\n              : {},\n        };\n      }\n    } catch {\n      // mantém defaults\n    }\n  }\n\n  getState(): OraculoContextState {\n    return {\n      // @oraculo-disable: tipo-literal-inline-complexo\n      schemaVersion: 1,\n      lastRuns: [...this.state.lastRuns],\n      preferences: { ...this.state.preferences },\n    };\n  }\n\n  getLastRun(): OraculoRunRecord | undefined {\n    return this.state.lastRuns[this.state.lastRuns.length - 1];\n  }\n\n  getPreference<T = unknown>(key: string): T | undefined {\n    return this.state.preferences[key] as T | undefined;\n  }\n\n  async setPreference(key: string, value: unknown): Promise<void> {\n    this.state.preferences[key] = value;\n    await this.persist();\n  }\n\n  async recordRunStart(\n    // @oraculo-disable: tipo-literal-inline-complexo\n    input: {\n      cwd: string;\n      argv: string[];\n      version?: string;\n      timestamp?: string;\n    },\n  ): Promise<string> {\n    const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n    const record: OraculoRunRecord = {\n      id,\n      timestamp: input.timestamp ?? new Date().toISOString(),\n      cwd: input.cwd,\n      argv: [...input.argv],\n      version: input.version,\n    };\n\n    this.state.lastRuns.push(record);\n    if (this.state.lastRuns.length > this.maxRuns) {\n      this.state.lastRuns = this.state.lastRuns.slice(-this.maxRuns);\n    }\n\n    await this.persist();\n    return id;\n  }\n\n  async recordRunEnd(\n    id: string,\n    // @oraculo-disable: tipo-literal-inline-complexo\n    update: {\n      ok: boolean;\n      exitCode?: number;\n      durationMs?: number;\n      error?: string;\n    },\n  ): Promise<void> {\n    const idx = this.state.lastRuns.findIndex((r) => r.id === id);\n    if (idx === -1) return;\n    const prev = this.state.lastRuns[idx];\n    this.state.lastRuns[idx] = {\n      ...prev,\n      ok: update.ok,\n      exitCode: update.exitCode,\n      durationMs: update.durationMs,\n      error: update.error,\n    };\n    await this.persist();\n  }\n\n  async clear(): Promise<void> {\n    this.state.lastRuns = [];\n    this.state.preferences = {};\n    await this.persist();\n  }\n\n  private async persist(): Promise<void> {\n    if (!this.persistPath) return;\n    try {\n      await mkdir(dirname(this.persistPath), { recursive: true });\n      await writeFile(\n        this.persistPath,\n        JSON.stringify(this.state, null, 2),\n        'utf-8',\n      );\n    } catch {\n      // ignore persist errors\n    }\n  }\n}\n\nexport async function getDefaultMemory(): Promise<ConversationMemory> {\n  // Preferimos memória por projeto (cwd) para evitar misturar repositórios.\n  const persistPath = join(process.cwd(), '.oraculo', 'history.json');\n  const mem = new ConversationMemory(10, persistPath);\n  await mem.init();\n  return mem;\n}\n\nexport async function getDefaultContextMemory(): Promise<OraculoContextMemory> {\n  const persistPath = join(process.cwd(), '.oraculo', 'context.json');\n  const mem = new OraculoContextMemory(20, persistPath);\n  await mem.init();\n  return mem;\n}\n"]}