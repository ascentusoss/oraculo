{"version":3,"file":"fragmentar-relatorio.js","sourceRoot":"","sources":["../../../src/shared/data-processing/fragmentar-relatorio.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport path from 'node:path';\nimport { gzipSync } from 'node:zlib';\n\nimport { config } from '@core/config/config.js';\nimport {\n  salvarBinario,\n  salvarEstado,\n} from '@shared/persistence/persistencia.js';\n\nimport type {\n  FileEntryFragmentacao,\n  FragmentOptions,\n  Manifest,\n  ManifestPartFragmentacao,\n  Ocorrencia,\n  RelatorioCompletoFragmentacao,\n} from '@';\n\n// Aliases para compatibilidade\ntype FileEntry = FileEntryFragmentacao;\ntype ManifestPart = ManifestPartFragmentacao;\ntype RelatorioCompleto = RelatorioCompletoFragmentacao;\n\n// Re-exporta os tipos para compatibilidade\nexport type {\n  FileEntry,\n  FragmentOptions,\n  Manifest,\n  ManifestPart,\n  RelatorioCompleto,\n};\n\nfunction chunkArray<T>(arr: T[], size: number): T[][] {\n  const out: T[][] = [];\n  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));\n  return out;\n}\n\nexport async function fragmentarRelatorio(\n  relatorioFull: RelatorioCompleto,\n  dir: string,\n  ts: string,\n  options?: FragmentOptions,\n): Promise<{ manifestFile: string; manifest: Manifest }> {\n  const maxOcorrencias =\n    options?.maxOcorrenciasPerShard ??\n    config.REPORT_FRAGMENT_OCCURRENCES ??\n    2000;\n  const maxFileEntries =\n    options?.maxFileEntriesPerShard ??\n    config.REPORT_FRAGMENT_FILEENTRIES ??\n    500;\n  const topN = config.REPORT_FRAGMENT_SUMMARY_TOPN ?? 5;\n\n  // Normaliza a estrutura esperada\n  const rel = relatorioFull as Record<string, unknown>;\n  const resultado =\n    rel && 'resultado' in rel\n      ? (rel.resultado as Record<string, unknown>)\n      : (rel as Record<string, unknown>);\n\n  const ocorrencias: Ocorrencia[] =\n    resultado &&\n    Array.isArray((resultado as Record<string, unknown>).ocorrencias)\n      ? ((resultado as Record<string, unknown>).ocorrencias as Ocorrencia[])\n      : [];\n  const fileEntries: FileEntry[] =\n    resultado &&\n    Array.isArray((resultado as Record<string, unknown>).fileEntries)\n      ? ((resultado as Record<string, unknown>).fileEntries as FileEntry[])\n      : [];\n\n  const salvar = salvarEstado;\n\n  // Manifest que descreve as partes geradas\n  const manifest: Manifest = {\n    generatedAt: new Date().toISOString(),\n    baseName: `oraculo-relatorio-full-${ts}`,\n    parts: [],\n  };\n\n  // Salva meta (tudo exceto ocorrencias/fileEntries)\n  const meta = { ...rel } as Record<string, unknown>;\n  if (meta.resultado && typeof meta.resultado === 'object') {\n    const r = meta.resultado as Record<string, unknown>;\n    delete r.ocorrencias;\n    delete r.fileEntries;\n  }\n  const metaFilename = `oraculo-relatorio-full-${ts}-meta.json.gz`;\n  const metaBuf = Buffer.from(JSON.stringify(meta, null, 2), 'utf-8');\n  const metaGz = gzipSync(metaBuf);\n  await salvarBinario(path.join(dir, metaFilename), metaGz);\n  manifest.parts.push({\n    kind: 'meta',\n    file: metaFilename,\n    bytes: metaGz.length,\n  });\n\n  // Fragmenta ocorrencias se necessário\n  if (ocorrencias.length > 0) {\n    const occChunks = chunkArray(ocorrencias, maxOcorrencias);\n    for (let i = 0; i < occChunks.length; i++) {\n      const fname = `oraculo-relatorio-full-${ts}-ocorrencias-part-${i + 1}.json.gz`;\n      const payload = {\n        shard: { kind: 'ocorrencias', index: i + 1, total: occChunks.length },\n        count: occChunks[i].length,\n        ocorrencias: occChunks[i],\n      };\n      const buf = Buffer.from(JSON.stringify(payload, null, 2), 'utf-8');\n      const gz = gzipSync(buf);\n      await salvarBinario(path.join(dir, fname), gz);\n\n      // Gerar resumo por shard: top tipos e top arquivos (relPath)\n      const tiposCount: Record<string, number> = {};\n      const arquivosCount: Record<string, number> = {};\n      for (const o of occChunks[i] as Ocorrencia[]) {\n        // Suporta formatos legados com 'type' e 'path' para compatibilidade\n        const oLegacy = o as Ocorrencia & { type?: string; path?: string };\n        const t =\n          o && (o.tipo || oLegacy.type)\n            ? String(o.tipo ?? oLegacy.type)\n            : 'desconhecido';\n        tiposCount[t] = (tiposCount[t] || 0) + 1;\n        const relp =\n          o && (o.relPath || oLegacy.path)\n            ? String(o.relPath ?? oLegacy.path)\n            : 'desconhecido';\n        arquivosCount[relp] = (arquivosCount[relp] || 0) + 1;\n      }\n      const topTipos = Object.entries(tiposCount)\n        .sort((a, b) => b[1] - a[1])\n        .slice(0, topN)\n        .map(([k, v]) => ({ tipo: k, count: v }));\n      const topArquivos = Object.entries(arquivosCount)\n        .sort((a, b) => b[1] - a[1])\n        .slice(0, topN)\n        .map(([k, v]) => ({ arquivo: k, count: v }));\n\n      manifest.parts.push({\n        kind: 'ocorrencias',\n        file: fname,\n        index: i + 1,\n        total: occChunks.length,\n        count: occChunks[i].length,\n        bytes: gz.length,\n        summary: { topTipos, topArquivos },\n      });\n    }\n  }\n\n  // Fragmenta fileEntries (ASTs) se necessário\n  if (fileEntries.length > 0) {\n    const feChunks = chunkArray(fileEntries, maxFileEntries);\n    for (let i = 0; i < feChunks.length; i++) {\n      const fname = `oraculo-relatorio-full-${ts}-fileentries-part-${i + 1}.json.gz`;\n      const payload = {\n        shard: { kind: 'fileEntries', index: i + 1, total: feChunks.length },\n        count: feChunks[i].length,\n        fileEntries: feChunks[i],\n      };\n      const buf = Buffer.from(JSON.stringify(payload, null, 2), 'utf-8');\n      const gz = gzipSync(buf);\n      await salvarBinario(path.join(dir, fname), gz);\n\n      // Resumo por shard de fileEntries: top arquivos por tamanho (linhas) quando possível\n      const arquivosSummary: Array<{ arquivo: string; linhas?: number }> = [];\n      for (const fe of feChunks[i] as FileEntry[]) {\n        // Suporta formato legado com 'path' para compatibilidade\n        const feLegacy = fe as FileEntry & { path?: string };\n        const rel =\n          fe && (fe.relPath || fe.fullPath || feLegacy.path)\n            ? String(fe.relPath ?? fe.fullPath ?? feLegacy.path)\n            : 'desconhecido';\n        let linhas: number | undefined = undefined;\n        try {\n          if (fe && typeof fe.content === 'string')\n            linhas = fe.content.split(/\\r?\\n/).length;\n        } catch {}\n        arquivosSummary.push({ arquivo: rel, linhas });\n      }\n      const topArquivosByLinhas = arquivosSummary\n        .filter((a) => typeof a.linhas === 'number')\n        .sort((a, b) => (b.linhas ?? 0) - (a.linhas ?? 0))\n        .slice(0, topN);\n\n      manifest.parts.push({\n        kind: 'fileEntries',\n        file: fname,\n        index: i + 1,\n        total: feChunks.length,\n        count: feChunks[i].length,\n        bytes: gz.length,\n        summary: { topArquivosByLinhas },\n      });\n    }\n  }\n\n  // Salva o manifest final\n  const manifestFilename = `oraculo-relatorio-full-${ts}-manifest.json`;\n  await salvar(path.join(dir, manifestFilename), manifest);\n\n  return { manifestFile: manifestFilename, manifest };\n}\n\nexport default fragmentarRelatorio;\n"]}