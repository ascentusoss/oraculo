{"version":3,"file":"orquestrador-arquetipos.js","sourceRoot":"","sources":["../../../src/analistas/js-ts/orquestrador-arquetipos.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport { ARQUETIPOS } from '/estrategistas/arquetipos-defs.js';\nimport { detectarArquetipoNode } from '/plugins/detector-node.js';\nimport { detectarArquetipoXML } from '/plugins/detector-xml.js';\nimport { pontuarTodos } from '/pontuadores/pontuador.js';\nimport { detectarContextoProjeto } from '/contexto-projeto.js';\n\nimport type {\n  ArquetipoDeteccaoAnomalia,\n  ArquetipoEstruturaDef,\n  ResultadoDeteccaoArquetipo,\n} from '@';\n\n// Evita warning de unused import - função usada em runtime\nvoid detectarContextoProjeto;\n\n/**\n * Cria um resultado padrão para arquétipo desconhecido\n */\n\nfunction criarResultadoDesconhecido(\n  motivo?: string,\n): ResultadoDeteccaoArquetipo {\n  const anomalias: ArquetipoDeteccaoAnomalia[] = motivo\n    ? [\n        {\n          path: 'projeto',\n          motivo,\n          sugerido: 'Adicione mais arquivos ao projeto para melhor detecção',\n        },\n      ]\n    : [];\n\n  return {\n    nome: 'desconhecido',\n    score: 0,\n    confidence: 0,\n    matchedRequired: [],\n    missingRequired: [],\n    matchedOptional: [],\n    dependencyMatches: [],\n    filePatternMatches: [],\n    forbiddenPresent: [],\n    anomalias,\n    sugestaoPadronizacao: '',\n    explicacaoSimilaridade: '',\n    descricao: 'Arquétipo não identificado',\n  };\n}\n\n/**\n * Orquestrador central de detecção de arquétipos\n * Agrega votos dos detectores especializados e decide o arquétipo final\n *\n *  arquivos Lista de arquivos do projeto para análise\n *  Melhor arquétipo detectado ou 'desconhecido' se não identificado\n */\n\nexport function detectarArquetipo(\n  arquivos: string[],\n): ResultadoDeteccaoArquetipo {\n  // Early return para projetos muito pequenos (< 5 arquivos)\n  if (arquivos.length < 5) {\n    return criarResultadoDesconhecido(\n      'Projeto muito pequeno para análise de arquétipo',\n    );\n  }\n\n  // Performance: executar detectores de forma inteligente baseado nos tipos de arquivos\n  const candidatos: ResultadoDeteccaoArquetipo[] = [];\n\n  const hasJS = arquivos.some(\n    (f) =>\n      f.endsWith('.js') ||\n      f.endsWith('.ts') ||\n      f.endsWith('.jsx') ||\n      f.endsWith('.tsx'),\n  );\n  const _hasJava = arquivos.some((f) => f.endsWith('.java'));\n  const _hasKotlin = arquivos.some(\n    (f) => f.endsWith('.kt') || f.endsWith('.kts'),\n  );\n  const hasXML = arquivos.some((f) => f.endsWith('.xml'));\n  const hasPackageJson = arquivos.some((f) => f.endsWith('package.json'));\n\n  // Executar detectores baseado nos tipos de arquivos presentes (otimização de performance)\n  if (hasJS || hasPackageJson) {\n    candidatos.push(...detectarArquetipoNode(arquivos));\n  }\n\n  // Futuro: adicionar detectores para Java/Kotlin, etc.\n  // Exemplo:\n  // if (hasJava || hasKotlin) {\n  //   candidatos.push(...detectarArquetipoJavaKotlin(arquivos));\n  // }\n\n  if (hasXML) {\n    candidatos.push(...detectarArquetipoXML(arquivos));\n  }\n\n  let lista = candidatos;\n  if (!lista.length) {\n    // Fallback: usar o pontuador completo quando detectores especializados não retornarem candidatos\n    lista = pontuarTodos(arquivos);\n  }\n\n  // Se ainda vazio, é desconhecido\n  if (!lista.length) {\n    return {\n      nome: 'desconhecido',\n      score: 0,\n      confidence: 0,\n      matchedRequired: [],\n      missingRequired: [],\n      matchedOptional: [],\n      dependencyMatches: [],\n      filePatternMatches: [],\n      forbiddenPresent: [],\n      anomalias: [],\n      sugestaoPadronizacao: '',\n      explicacaoSimilaridade: '',\n      descricao: 'Arquétipo não identificado',\n    };\n  }\n\n  // Regra especial (compatibilidade com testes de penalidades):\n  // Se existir candidato cujo único \"sinal\" são diretórios proibidos presentes\n  // (sem matches de required/optional/dependency/pattern), priorizamos aquele\n  // com maior quantidade de diretórios proibidos detectados.\n  const apenasPenalidades = lista.filter((c) => {\n    const pos =\n      (c.matchedRequired?.length || 0) +\n      (c.matchedOptional?.length || 0) +\n      (c.dependencyMatches?.length || 0) +\n      (c.filePatternMatches?.length || 0);\n    const forb = c.forbiddenPresent?.length || 0;\n    return forb > 0 && pos === 0;\n  });\n  if (apenasPenalidades.length > 0) {\n    // Heurística de segurança: ignore o candidato 'monorepo-packages' quando o único forbidden presente for 'src'\n    // (cenário comum em projetos Node simples com pasta src/, que não devem ser classificados como monorepo).\n    const filtrados = apenasPenalidades.filter((c) => {\n      // Regra específica: se o candidato for 'monorepo-packages' e o único forbidden detectado for 'src', descartamos\n      if (c.nome === 'monorepo-packages') {\n        const forb = c.forbiddenPresent || [];\n        if (forb.length === 1 && forb[0] === 'src') return false;\n      }\n      return true;\n    });\n    if (filtrados.length === 0) {\n      // caso todos tenham sido filtrados, prossegue com fluxo normal\n    } else {\n      // desempate refinado: maior cobertura relativa de forbidden (detectados/definidos)\n      filtrados.sort((a, b) => {\n        const forbA = a.forbiddenPresent?.length || 0;\n        const forbB = b.forbiddenPresent?.length || 0;\n        // Usa somente o total de diretórios proibidos definidos no alvo para o ratio\n        const defA = ARQUETIPOS.find(\n          (d: ArquetipoEstruturaDef) => d.nome === a.nome,\n        ) as ArquetipoEstruturaDef | undefined;\n        const defB = ARQUETIPOS.find(\n          (d: ArquetipoEstruturaDef) => d.nome === b.nome,\n        ) as ArquetipoEstruturaDef | undefined;\n        const totA = defA?.forbiddenDirs?.length || 0;\n        const totB = defB?.forbiddenDirs?.length || 0;\n        const ratioA = totA > 0 ? forbA / totA : 0;\n        const ratioB = totB > 0 ? forbB / totB : 0;\n        if (ratioB !== ratioA) return ratioB - ratioA;\n        if (forbB !== forbA) return forbB - forbA;\n        // depois, mais missingRequired primeiro (penalidade maior do alvo)\n        const miss =\n          (b.missingRequired?.length || 0) - (a.missingRequired?.length || 0);\n        if (miss !== 0) return miss;\n        return a.nome.localeCompare(b.nome);\n      });\n      return filtrados[0];\n    }\n  }\n\n  // Ordenação: menor missingRequired, maior score, maior matchedRequired, maior confidence, nome asc\n  lista.sort((a, b) => {\n    const mm =\n      (a.missingRequired?.length || 0) - (b.missingRequired?.length || 0);\n    if (mm !== 0) return mm;\n    if (b.score !== a.score) return b.score - a.score;\n    const mr =\n      (b.matchedRequired?.length || 0) - (a.matchedRequired?.length || 0);\n    if (mr !== 0) return mr;\n    if (b.confidence !== a.confidence) return b.confidence - a.confidence;\n    return a.nome.localeCompare(b.nome);\n  });\n\n  const best = lista[0];\n  const hasSignals =\n    (best.matchedRequired?.length || 0) > 0 ||\n    (best.matchedOptional?.length || 0) > 0 ||\n    (best.dependencyMatches?.length || 0) > 0 ||\n    (best.filePatternMatches?.length || 0) > 0 ||\n    (best.forbiddenPresent?.length || 0) > 0;\n  if (!hasSignals) {\n    return {\n      nome: 'desconhecido',\n      score: 0,\n      confidence: 0,\n      matchedRequired: [],\n      missingRequired: [],\n      matchedOptional: [],\n      dependencyMatches: [],\n      filePatternMatches: [],\n      forbiddenPresent: [],\n      anomalias: [],\n      sugestaoPadronizacao: '',\n      explicacaoSimilaridade: '',\n      descricao: 'Arquétipo não identificado',\n    };\n  }\n  return best;\n}\n"]}