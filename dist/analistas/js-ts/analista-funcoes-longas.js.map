{"version":3,"file":"analista-funcoes-longas.js","sourceRoot":"","sources":["../../../src/analistas/js-ts/analista-funcoes-longas.ts"],"names":[],"mappings":"AAGA,OAAO,EAAE,MAAM,EAAE,MAAM,wBAAwB,CAAC;AAChD,OAAO,EAAE,uBAAuB,EAAE,MAAM,6BAA6B,CAAC;AAGtE,OAAO,EAAE,aAAa,EAAE,WAAW,EAAE,MAAM,GAAG,CAAC;AAE/C,SAAS,UAAU,CAAC,CAAU;IAC5B,OAAO,CACL,OAAO,CAAC,KAAK,QAAQ;QACrB,CAAC,KAAK,IAAI;QACV,MAAM,IAAI,CAAC;QACX,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC;QACnB,OAAQ,CAA4B,CAAC,QAAQ,KAAK,UAAU,CAC7D,CAAC;AACJ,CAAC;AAED,MAAM,aAAa,GAAG,MAAM,CAAC,eAAe,EAAE,cAAc,EAAE,UAAU,IAAI,EAAE,CAAC;AAC/E,MAAM,iBAAiB,GACrB,MAAM,CAAC,eAAe,EAAE,cAAc,EAAE,cAAc,IAAI,CAAC,CAAC;AAC9D,MAAM,kBAAkB,GACtB,MAAM,CAAC,eAAe,EAAE,cAAc,EAAE,eAAe,IAAI,CAAC,CAAC;AAE/D,MAAM,CAAC,MAAM,qBAAqB,GAAG,aAAa,CAAC;IACjD,OAAO,CACL,GAAW,EACX,OAAe,EACf,GAAiC,EACjC,SAAkB;QAGlB,MAAM,eAAe,GAAG,uBAAuB,CAAC;YAC9C,OAAO,EAAE,OAAO;YAChB,QAAQ,EAAE,GAAG;YACb,OAAO;SACR,CAAC,CAAC;QAGH,MAAM,gBAAgB,GAAG;YACvB,MAAM,EACJ,eAAe,CAAC,MAAM,IAAI,eAAe,CAAC,QAAQ;gBAChD,CAAC,CAAC,aAAa,GAAG,CAAC;gBACnB,CAAC,CAAC,aAAa;YACnB,UAAU,EAAE,eAAe,CAAC,MAAM;gBAChC,CAAC,CAAC,iBAAiB,GAAG,CAAC;gBACvB,CAAC,CAAC,iBAAiB;YACrB,WAAW,EAAE,kBAAkB;SAChC,CAAC;QAEF,MAAM,WAAW,GAAiB,EAAE,CAAC;QAErC,MAAM,cAAc,GAAG,CACrB,IAAwB,EACxB,KAAuC,EACvC,KAAa,EACb,QAAgB,EAChB,EAAE;YACF,WAAW,CAAC,IAAI,CAAC;gBACf,IAAI;gBACJ,KAAK;gBACL,OAAO;gBACP,OAAO,EAAE,OAAO;gBAChB,KAAK;gBACL,QAAQ;gBACR,MAAM,EAAE,yBAAyB;aAClC,CAAC,CAAC;QACL,CAAC,CAAC;QAEF,SAAS,QAAQ,CAAC,EAAoB,EAAE,eAAuB,CAAC;YAC9D,MAAM,GAAG,GAAG,EAAE,CAAC,GAAG,CAAC;YACnB,IACE,CAAC,GAAG;gBACJ,OAAO,GAAG,CAAC,KAAK,KAAK,QAAQ;gBAC7B,OAAO,GAAG,CAAC,GAAG,KAAK,QAAQ;gBAC3B,OAAO,GAAG,CAAC,KAAK,CAAC,IAAI,KAAK,QAAQ;gBAClC,OAAO,GAAG,CAAC,GAAG,CAAC,IAAI,KAAK,QAAQ;gBAChC,GAAG,CAAC,KAAK,CAAC,IAAI,GAAG,CAAC;gBAClB,GAAG,CAAC,GAAG,CAAC,IAAI,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,EAC7B,CAAC;gBACD,OAAO;YACT,CAAC;YAED,MAAM,SAAS,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC;YACjC,MAAM,OAAO,GAAG,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC;YAC7B,MAAM,MAAM,GAAG,OAAO,GAAG,SAAS,GAAG,CAAC,CAAC;YACvC,IAAI,MAAM,GAAG,gBAAgB,CAAC,MAAM,EAAE,CAAC;gBACrC,cAAc,CACZ,cAAc,EACd,OAAO,EACP,SAAS,EACT,cAAc,MAAM,iBAAiB,gBAAgB,CAAC,MAAM,GAAG,CAChE,CAAC;YACJ,CAAC;YAED,MAAM,SAAS,GAAG,EAAE,CAAC,MAAM,CAAC;YAC5B,IACE,SAAS;gBACT,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC;gBACxB,SAAS,CAAC,MAAM,GAAG,gBAAgB,CAAC,UAAU,EAC9C,CAAC;gBACD,cAAc,CACZ,mBAAmB,EACnB,OAAO,EACP,SAAS,EACT,iCAAiC,SAAS,CAAC,MAAM,UAAU,gBAAgB,CAAC,UAAU,GAAG,CAC1F,CAAC;YACJ,CAAC;YAGD,IAAI,YAAY,GAAG,gBAAgB,CAAC,WAAW,EAAE,CAAC;gBAChD,cAAc,CACZ,iBAAiB,EACjB,OAAO,EACP,SAAS,EACT,4BAA4B,YAAY,UAAU,gBAAgB,CAAC,WAAW,GAAG,CAClF,CAAC;YACJ,CAAC;YAGD,IACE,EAAE,CAAC,eAAe,IAAI,IAAI;gBAC1B,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC,eAAe,CAAC,IAAI,EAAE,CAAC,eAAe,CAAC,MAAM,KAAK,CAAC,CAAC,EACtE,CAAC;gBACD,IAAI,CAAC,eAAe,CAAC,MAAM,EAAE,CAAC;oBAE5B,cAAc,CACZ,uBAAuB,EACvB,MAAM,EACN,SAAS,EACT,8BAA8B,CAC/B,CAAC;gBACJ,CAAC;YACH,CAAC;QACH,CAAC;QAED,SAAS,iBAAiB,CACxB,IAA2B,EAC3B,cAAsB,CAAC;YAEvB,MAAM,IAAI,GAAG,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAE,IAAa,CAAC;YAC3D,MAAM,IAAI,GAAI,IAA0B,CAAC,IAAI,CAAC;YAC9C,IACE,IAAI,KAAK,qBAAqB;gBAC9B,IAAI,KAAK,oBAAoB;gBAC7B,IAAI,KAAK,yBAAyB,EAClC,CAAC;gBAED,MAAM,MAAM,GAAG,IAAmC,CAAC;gBACnD,QAAQ,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC;gBAC9B,WAAW,EAAE,CAAC;YAChB,CAAC;YACD,IAAI,UAAU,CAAC,IAAI,CAAC,IAAI,OAAO,IAAI,CAAC,QAAQ,KAAK,UAAU,EAAE,CAAC;gBAC5D,IAAI,CAAC,QAAQ,CAAC;oBACZ,mBAAmB,CAAC,CAAiB;wBACnC,iBAAiB,CAAC,CAAC,EAAE,WAAW,GAAG,CAAC,CAAC,CAAC;oBACxC,CAAC;oBACD,kBAAkB,CAAC,CAAiB;wBAClC,iBAAiB,CAAC,CAAC,EAAE,WAAW,GAAG,CAAC,CAAC,CAAC;oBACxC,CAAC;oBACD,uBAAuB,CAAC,CAAiB;wBACvC,iBAAiB,CAAC,CAAC,EAAE,WAAW,GAAG,CAAC,CAAC,CAAC;oBACxC,CAAC;iBACF,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAID,IACE,GAAG;YACH,OAAQ,GAAyC,CAAC,QAAQ,KAAK,UAAU,EACzE,CAAC;YACD,iBAAiB,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;YAC1B,OAAO,WAAW,CAAC;QACrB,CAAC;QAGD,MAAM,OAAO,GAAG,GAAiC,CAAC;QAClD,IAAI,QAAQ,GAAoB,IAAI,CAAC;QACrC,IAAI,CAAC;YACH,IAAI,OAAO,EAAE,CAAC;gBACZ,MAAM,EAAE,GAAG,OAAkB,CAAC;gBAC9B,IAAI,EAAE,IAAI,OAAO,EAAE,KAAK,QAAQ,EAAE,CAAC;oBACjC,MAAM,SAAS,GAAI,EAAyB,CAAC,IAAI,CAAC;oBAClD,IACE,SAAS;wBACT,OAAO,SAAS,KAAK,QAAQ;wBAC7B,KAAK,CAAC,OAAO,CAAE,SAAgC,CAAC,IAAI,CAAC,EACrD,CAAC;wBACD,QAAQ,GAAG,SAAqB,CAAC;oBACnC,CAAC;yBAAM,IAAI,KAAK,CAAC,OAAO,CAAE,EAAyB,CAAC,IAAI,CAAC,EAAE,CAAC;wBAC1D,QAAQ,GAAG,OAAO,CAAC;oBACrB,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;QAAC,MAAM,CAAC;YACP,QAAQ,GAAG,IAAI,CAAC;QAClB,CAAC;QAED,IAAI,QAAQ,EAAE,CAAC;YACb,MAAM,IAAI,GAAG,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC;YAC/D,KAAK,MAAM,KAAK,IAAI,IAAI,EAAE,CAAC;gBACzB,IACE,KAAK;oBACL,OAAO,KAAK,KAAK,QAAQ;oBACzB,CAAE,KAA2B,CAAC,IAAI,KAAK,qBAAqB;wBACzD,KAA2B,CAAC,IAAI,KAAK,oBAAoB;wBACzD,KAA2B,CAAC,IAAI,KAAK,yBAAyB,CAAC,EAClE,CAAC;oBACD,QAAQ,CAAC,KAAyB,EAAE,CAAC,CAAC,CAAC;gBACzC,CAAC;YACH,CAAC;YACD,OAAO,WAAW,CAAC;QACrB,CAAC;QAGD,OAAO,WAAW,CAAC;IACrB,CAAC;IACD,IAAI,EAAE,yBAAyB;IAC/B,SAAS,EAAE,cAAc;IACzB,SAAS,EACP,8FAA8F;IAChG,OAAO,EAAE;QACP,MAAM,EAAE,aAAa;QACrB,MAAM,EAAE,iBAAiB;QACzB,WAAW,EAAE,kBAAkB;KAChC;IACD,IAAI,EAAE,CAAC,OAAe,EAAW,EAAE,CACjC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC;IACpD,MAAM,EAAE,KAAK;CACd,CAAC,CAAC","sourcesContent":["// SPDX-License-Identifier: MIT\nimport type { NodePath } from '/traverse';\nimport type { Node } from '/types';\nimport { config } from '/config/config.js';\nimport { detectarContextoProjeto } from '/contexto-projeto.js';\n\nimport type { FileLike, FunctionLikeNode, Ocorrencia } from '@';\nimport { criarAnalista, isBabelNode } from '@';\n\nfunction isNodePath(x: unknown): x is NodePath<Node> {\n  return (\n    typeof x === 'object' &&\n    x !== null &&\n    'node' in x &&\n    isBabelNode(x.node) &&\n    typeof (x as { traverse?: unknown }).traverse === 'function'\n  );\n}\n\nconst LIMITE_LINHAS = config.ANALISE_LIMITES?.FUNCOES_LONGAS?.MAX_LINHAS ?? 30;\nconst LIMITE_PARAMETROS =\n  config.ANALISE_LIMITES?.FUNCOES_LONGAS?.MAX_PARAMETROS ?? 4;\nconst LIMITE_ANINHAMENTO =\n  config.ANALISE_LIMITES?.FUNCOES_LONGAS?.MAX_ANINHAMENTO ?? 3;\n\nexport const analistaFuncoesLongas = criarAnalista({\n  aplicar(\n    src: string,\n    relPath: string,\n    ast: NodePath<Node> | Node | null,\n    _fullPath?: string,\n  ) {\n    // Aplicar contexto inteligente\n    const contextoArquivo = detectarContextoProjeto({\n      arquivo: relPath,\n      conteudo: src,\n      relPath,\n    });\n\n    // Limites mais relaxados para testes e configurações\n    const limitesAjustados = {\n      linhas:\n        contextoArquivo.isTest || contextoArquivo.isConfig\n          ? LIMITE_LINHAS * 2\n          : LIMITE_LINHAS,\n      parametros: contextoArquivo.isTest\n        ? LIMITE_PARAMETROS + 2\n        : LIMITE_PARAMETROS,\n      aninhamento: LIMITE_ANINHAMENTO,\n    };\n\n    const ocorrencias: Ocorrencia[] = [];\n\n    const pushOcorrencia = (\n      tipo: Ocorrencia['tipo'],\n      nivel: NonNullable<Ocorrencia['nivel']>,\n      linha: number,\n      mensagem: string,\n    ) => {\n      ocorrencias.push({\n        tipo,\n        nivel,\n        relPath,\n        arquivo: relPath,\n        linha,\n        mensagem,\n        origem: 'analista-funcoes-longas',\n      });\n    };\n\n    function analisar(fn: FunctionLikeNode, _aninhamento: number = 0): void {\n      const loc = fn.loc;\n      if (\n        !loc ||\n        typeof loc.start !== 'object' ||\n        typeof loc.end !== 'object' ||\n        typeof loc.start.line !== 'number' ||\n        typeof loc.end.line !== 'number' ||\n        loc.start.line < 1 ||\n        loc.end.line < loc.start.line\n      ) {\n        return;\n      }\n\n      const startLine = loc.start.line;\n      const endLine = loc.end.line;\n      const linhas = endLine - startLine + 1;\n      if (linhas > limitesAjustados.linhas) {\n        pushOcorrencia(\n          'FUNCAO_LONGA',\n          'aviso',\n          startLine,\n          `Função com ${linhas} linhas (máx: ${limitesAjustados.linhas})`,\n        );\n      }\n\n      const paramsArr = fn.params;\n      if (\n        paramsArr &&\n        Array.isArray(paramsArr) &&\n        paramsArr.length > limitesAjustados.parametros\n      ) {\n        pushOcorrencia(\n          'MUITOS_PARAMETROS',\n          'aviso',\n          startLine,\n          `Função com muitos parâmetros (${paramsArr.length}, máx: ${limitesAjustados.parametros})`,\n        );\n      }\n\n      // Verifica se a função está aninhada demais\n      if (_aninhamento > limitesAjustados.aninhamento) {\n        pushOcorrencia(\n          'FUNCAO_ANINHADA',\n          'aviso',\n          startLine,\n          `Função aninhada em nível ${_aninhamento} (máx: ${limitesAjustados.aninhamento})`,\n        );\n      }\n\n      // Verifica se a função não tem comentário - menos rigoroso para testes\n      if (\n        fn.leadingComments == null ||\n        (Array.isArray(fn.leadingComments) && fn.leadingComments.length === 0)\n      ) {\n        if (!contextoArquivo.isTest) {\n          // Testes não precisam comentários obrigatórios\n          pushOcorrencia(\n            'FUNCAO_SEM_COMENTARIO',\n            'info',\n            startLine,\n            `Função sem comentário acima.`,\n          );\n        }\n      }\n    }\n\n    function analisarRecursivo(\n      path: NodePath<Node> | Node,\n      aninhamento: number = 0,\n    ) {\n      const node = isNodePath(path) ? path.node : (path as Node);\n      const type = (node as { type?: string }).type;\n      if (\n        type === 'FunctionDeclaration' ||\n        type === 'FunctionExpression' ||\n        type === 'ArrowFunctionExpression'\n      ) {\n        // garantir que 'node' atenda à forma mínima esperada por analisar\n        const fnNode = node as unknown as FunctionLikeNode;\n        analisar(fnNode, aninhamento);\n        aninhamento++;\n      }\n      if (isNodePath(path) && typeof path.traverse === 'function') {\n        path.traverse({\n          FunctionDeclaration(p: NodePath<Node>) {\n            analisarRecursivo(p, aninhamento + 1);\n          },\n          FunctionExpression(p: NodePath<Node>) {\n            analisarRecursivo(p, aninhamento + 1);\n          },\n          ArrowFunctionExpression(p: NodePath<Node>) {\n            analisarRecursivo(p, aninhamento + 1);\n          },\n        });\n      }\n    }\n\n    // --- Fluxo centralizado e robusto ---\n    // 1. NodePath real: use traverse e recursão\n    if (\n      ast &&\n      typeof (ast as unknown as { traverse?: unknown }).traverse === 'function'\n    ) {\n      analisarRecursivo(ast, 0);\n      return ocorrencias;\n    }\n\n    // 2. AST puro ou mock: só processa body do File, nunca recursiona\n    const fileAst = ast as unknown as FileLike | null;\n    let fileNode: FileLike | null = null;\n    try {\n      if (fileAst) {\n        const fa = fileAst as unknown;\n        if (fa && typeof fa === 'object') {\n          const maybeNode = (fa as { node?: unknown }).node;\n          if (\n            maybeNode &&\n            typeof maybeNode === 'object' &&\n            Array.isArray((maybeNode as { body?: unknown }).body)\n          ) {\n            fileNode = maybeNode as FileLike;\n          } else if (Array.isArray((fa as { body?: unknown }).body)) {\n            fileNode = fileAst;\n          }\n        }\n      }\n    } catch {\n      fileNode = null;\n    }\n\n    if (fileNode) {\n      const body = Array.isArray(fileNode.body) ? fileNode.body : [];\n      for (const child of body) {\n        if (\n          child &&\n          typeof child === 'object' &&\n          ((child as { type?: string }).type === 'FunctionDeclaration' ||\n            (child as { type?: string }).type === 'FunctionExpression' ||\n            (child as { type?: string }).type === 'ArrowFunctionExpression')\n        ) {\n          analisar(child as FunctionLikeNode, 0);\n        }\n      }\n      return ocorrencias;\n    }\n\n    // Se não for nenhum dos casos acima, retorna vazio\n    return ocorrencias;\n  },\n  nome: 'analista-funcoes-longas',\n  categoria: 'complexidade',\n  descricao:\n    'Detecta funcoes muito longas, com muitos parametros, aninhamento excessivo ou sem comentario',\n  limites: {\n    linhas: LIMITE_LINHAS,\n    params: LIMITE_PARAMETROS,\n    aninhamento: LIMITE_ANINHAMENTO,\n  },\n  test: (relPath: string): boolean =>\n    relPath.endsWith('.js') || relPath.endsWith('.ts'),\n  global: false,\n});\n"]}