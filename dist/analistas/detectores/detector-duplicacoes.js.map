{"version":3,"file":"detector-duplicacoes.js","sourceRoot":"","sources":["../../../src/analistas/detectores/detector-duplicacoes.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport type { NodePath } from '@babel/traverse';\nimport type {\n  ArrowFunctionExpression,\n  ClassMethod,\n  FunctionDeclaration,\n  FunctionExpression,\n  Node,\n  ObjectMethod,\n} from '@babel/types';\nimport { traverse } from '@core/config/traverse.js';\nimport { DetectorAgregadosMessages } from '@core/messages/analistas/detector-agregados-messages.js';\nimport { createHash } from 'crypto';\n\nimport type {\n  Analista,\n  BlocoFuncao,\n  ContextoExecucao,\n  DuplicacaoEncontrada,\n  Ocorrencia,\n} from '@';\nimport { criarOcorrencia } from '@';\n\nexport const analistaDuplicacoes: Analista = {\n  nome: 'detector-duplicacoes',\n  categoria: 'estrutura',\n  descricao: 'Detecta funções e blocos de código duplicados ou muito similares',\n  limites: {\n    similaridadeMinima: 80,\n    tamanhoMinimoFuncao: 5,\n  },\n\n  test: (relPath: string): boolean => {\n    return /\\.(js|jsx|ts|tsx|mjs|cjs)$/.test(relPath);\n  },\n\n  aplicar: async (\n    src: string,\n    relPath: string,\n    ast: NodePath<Node> | null,\n    fullPath?: string,\n    contexto?: ContextoExecucao,\n  ): Promise<Ocorrencia[]> => {\n    if (!ast || !src || !contexto) {\n      return [];\n    }\n\n    try {\n      // Extrair todas as funções do arquivo atual\n      const funcoesAtuais = extrairFuncoes(ast, relPath, src);\n\n      // Extrair funções de outros arquivos para comparação\n      let todasFuncoes: BlocoFuncao[] = [];\n      try {\n        todasFuncoes = await extrairFuncoesDoContexto(contexto, relPath);\n      } catch (erro) {\n        return [\n          criarOcorrencia({\n            tipo: 'erro_analise',\n            nivel: 'aviso',\n            mensagem: DetectorAgregadosMessages.erroAnalisarDuplicacoes(erro),\n            relPath,\n            linha: 1,\n          }),\n        ];\n      }\n      todasFuncoes.push(...funcoesAtuais);\n\n      // Detectar duplicações\n      const duplicacoes = detectarDuplicacoes(funcoesAtuais, todasFuncoes);\n\n      if (duplicacoes.length === 0) {\n        return [];\n      }\n\n      // Agrupar por tipo de similaridade\n      const porTipo = agruparPorTipoSimilaridade(duplicacoes);\n      const ocorrencias: Ocorrencia[] = [];\n\n      for (const [tipo, dups] of Object.entries(porTipo)) {\n        if (dups.length > 0) {\n          const nivel = tipo === 'identica' ? 'aviso' : 'info';\n          const primeiraFunc = dups[0]?.funcaoA;\n\n          const resumo = dups\n            .map(\n              (d) =>\n                `${d.funcaoA?.nome || 'unknown'} ≈ ${d.funcaoB?.nome || 'unknown'} (${d.similaridade.toFixed(0)}%)`,\n            )\n            .slice(0, 3)\n            .join(', ');\n\n          ocorrencias.push(\n            criarOcorrencia({\n              tipo: 'codigo_duplicado',\n              nivel,\n              mensagem: DetectorAgregadosMessages.duplicacoesResumo(\n                tipo,\n                resumo,\n                dups.length,\n              ),\n              relPath,\n              linha: primeiraFunc?.inicio || 1,\n            }),\n          );\n        }\n      }\n\n      return ocorrencias;\n    } catch (erro) {\n      return [\n        criarOcorrencia({\n          tipo: 'erro_analise',\n          nivel: 'aviso',\n          mensagem: DetectorAgregadosMessages.erroAnalisarDuplicacoes(erro),\n          relPath,\n          linha: 1,\n        }),\n      ];\n    }\n  },\n};\n\nfunction extrairFuncoes(\n  ast: NodePath<Node>,\n  caminho: string,\n  src: string,\n): BlocoFuncao[] {\n  const funcoes: BlocoFuncao[] = [];\n  const linhas = src.split('\\n');\n\n  traverse(ast.node, {\n    FunctionDeclaration(path: NodePath<FunctionDeclaration>) {\n      const func = extrairInfoFuncao(path, caminho, 'declaration', linhas);\n      if (func) funcoes.push(func);\n    },\n\n    FunctionExpression(path: NodePath<FunctionExpression>) {\n      const func = extrairInfoFuncao(path, caminho, 'expression', linhas);\n      if (func) funcoes.push(func);\n    },\n\n    ArrowFunctionExpression(path: NodePath<ArrowFunctionExpression>) {\n      const func = extrairInfoFuncao(path, caminho, 'arrow', linhas);\n      if (func) funcoes.push(func);\n    },\n\n    ObjectMethod(path: NodePath<ObjectMethod>) {\n      const func = extrairInfoFuncao(path, caminho, 'method', linhas);\n      if (func) funcoes.push(func);\n    },\n\n    ClassMethod(path: NodePath<ClassMethod>) {\n      const func = extrairInfoFuncao(path, caminho, 'method', linhas);\n      if (func) funcoes.push(func);\n    },\n  });\n\n  return funcoes;\n}\n\nfunction extrairInfoFuncao(\n  path: NodePath,\n  caminho: string,\n  tipoFuncao: BlocoFuncao['tipoFuncao'],\n  linhas: string[],\n): BlocoFuncao | null {\n  const node = path.node;\n\n  const inicio = node.loc?.start.line || 0;\n  const fim = node.loc?.end.line || 0;\n\n  // Ignorar funções muito pequenas\n  if (fim - inicio < 3) {\n    return null;\n  }\n\n  const conteudo = linhas.slice(inicio - 1, fim).join('\\n');\n  const conteudoNormalizado = normalizarConteudo(conteudo);\n  // MD5 usado apenas para fingerprinting rápido de código (detecção de duplicação)\n  // Não é usado para segurança/criptografia - contexto: cache de análise estática\n  const hash = createHash('md5').update(conteudoNormalizado).digest('hex');\n\n  // Extrair nome da função\n  let nome = 'anonymous';\n  if ('id' in node && node.id && 'name' in node.id) {\n    nome = node.id.name;\n  } else if ('key' in node && node.key && 'name' in node.key) {\n    nome = node.key.name as string;\n  } else if (path.parentPath?.isVariableDeclarator()) {\n    const parent = path.parentPath.node;\n    nome =\n      'id' in parent && parent.id && 'name' in parent.id\n        ? (parent.id.name as string)\n        : 'assigned';\n  }\n\n  // Extrair parâmetros\n  const parametros = (\n    'params' in node && Array.isArray(node.params) ? node.params : []\n  ).map((param: Node) => {\n    // Function parameter nodes\n    if (param.type === 'Identifier' && 'name' in param)\n      return param.name as string; // Identifier node\n    if (\n      param.type === 'RestElement' &&\n      'argument' in param &&\n      param.argument &&\n      'name' in param.argument\n    ) {\n      return `...${param.argument.name as string}`; // RestElement node\n    }\n    return param.type;\n  });\n\n  return {\n    hash,\n    conteudo: conteudoNormalizado,\n    nome,\n    caminho,\n    inicio,\n    fim,\n    parametros,\n    tipoFuncao,\n    codigo: conteudoNormalizado,\n  };\n}\n\nasync function extrairFuncoesDoContexto(\n  contexto: ContextoExecucao,\n  caminhoAtual: string,\n): Promise<BlocoFuncao[]> {\n  const todasFuncoes: BlocoFuncao[] = [];\n\n  // Limitar a análise a alguns arquivos para performance\n  const arquivosParaComparar = contexto.arquivos\n    .filter((arq) => arq.relPath !== caminhoAtual && arq.ast)\n    .slice(0, 20); // Limitar para evitar overhead\n\n  for (const arquivo of arquivosParaComparar) {\n    if (arquivo.ast && arquivo.content) {\n      // Verificar se o AST é do tipo correto (NodePath<Node>)\n      if ('parent' in arquivo.ast && 'node' in arquivo.ast) {\n        const funcoes = extrairFuncoes(\n          arquivo.ast as NodePath<Node>,\n          arquivo.relPath,\n          arquivo.content,\n        );\n        todasFuncoes.push(...funcoes);\n      }\n    }\n  }\n\n  return todasFuncoes;\n}\n\nfunction detectarDuplicacoes(\n  funcoesAtuais: BlocoFuncao[],\n  todasFuncoes: BlocoFuncao[],\n): DuplicacaoEncontrada[] {\n  const duplicacoes: DuplicacaoEncontrada[] = [];\n\n  for (const funcaoAtual of funcoesAtuais) {\n    for (const outraFuncao of todasFuncoes) {\n      // Não comparar função consigo mesma\n      if (\n        funcaoAtual.caminho === outraFuncao.caminho &&\n        funcaoAtual.inicio === outraFuncao.inicio\n      ) {\n        continue;\n      }\n\n      const similaridade = calcularSimilaridade(funcaoAtual, outraFuncao);\n\n      if (similaridade >= 80) {\n        const tipoSimilaridade = determinarTipoSimilaridade(\n          funcaoAtual,\n          outraFuncao,\n          similaridade,\n        );\n\n        duplicacoes.push({\n          funcaoA: funcaoAtual,\n          funcaoB: outraFuncao,\n          similaridade,\n          tipoSimilaridade,\n          arquivo1: funcaoAtual.caminho || '',\n          arquivo2: outraFuncao.caminho || '',\n          bloco1: funcaoAtual,\n          bloco2: outraFuncao,\n        });\n      }\n    }\n  }\n\n  return duplicacoes;\n}\n\nfunction calcularSimilaridade(\n  funcaoA: BlocoFuncao,\n  funcaoB: BlocoFuncao,\n): number {\n  // Similaridade por hash (exata)\n  if (funcaoA.hash === funcaoB.hash) {\n    return 100;\n  }\n\n  // Similaridade estrutural (tokens)\n  const tokensA = tokenizar(funcaoA.conteudo || '');\n  const tokensB = tokenizar(funcaoB.conteudo || '');\n\n  const similaridadeJaccard = calcularJaccard(tokensA, tokensB);\n\n  // Bonus se parâmetros forem similares\n  const similaridadeParametros = calcularSimilaridadeParametros(\n    funcaoA.parametros || [],\n    funcaoB.parametros || [],\n  );\n\n  return (similaridadeJaccard * 0.8 + similaridadeParametros * 0.2) * 100;\n}\n\nfunction determinarTipoSimilaridade(\n  funcaoA: BlocoFuncao,\n  funcaoB: BlocoFuncao,\n  similaridade: number,\n): DuplicacaoEncontrada['tipoSimilaridade'] {\n  if (similaridade >= 95) return 'identica';\n  if (similaridade >= 85) return 'estrutural';\n  return 'semantica';\n}\n\nfunction normalizarConteudo(conteudo: string): string {\n  return (\n    conteudo\n      // Remover comentários\n      .replace(/\\/\\/.*$/gm, '')\n      .replace(/\\/\\*[\\s\\S]*?\\*\\//g, '')\n      // Normalizar espaços\n      .replace(/\\s+/g, ' ')\n      // Remover espaços antes/depois de símbolos\n      .replace(/\\s*([{}();,])\\s*/g, '$1')\n      .trim()\n  );\n}\n\nfunction tokenizar(texto: string): string[] {\n  return texto\n    .split(/[\\s\\(\\)\\{\\}\\[\\];,\\.]+/)\n    .filter((token) => token.length > 0 && !/^[0-9]+$/.test(token)); // Remover números puros\n}\n\nfunction calcularJaccard(tokensA: string[], tokensB: string[]): number {\n  const conjuntoA = new Set(tokensA);\n  const conjuntoB = new Set(tokensB);\n\n  const intersecao = new Set([...conjuntoA].filter((x) => conjuntoB.has(x)));\n  const uniao = new Set([...conjuntoA, ...conjuntoB]);\n\n  return uniao.size === 0 ? 0 : intersecao.size / uniao.size;\n}\n\nfunction calcularSimilaridadeParametros(\n  paramsA: string[],\n  paramsB: string[],\n): number {\n  if (paramsA.length === 0 && paramsB.length === 0) return 1;\n  if (paramsA.length === 0 || paramsB.length === 0) return 0;\n\n  const maxLength = Math.max(paramsA.length, paramsB.length);\n  let matches = 0;\n\n  for (let i = 0; i < maxLength; i++) {\n    if (paramsA[i] === paramsB[i]) {\n      matches++;\n    }\n  }\n\n  return matches / maxLength;\n}\n\nfunction agruparPorTipoSimilaridade(\n  duplicacoes: DuplicacaoEncontrada[],\n): Record<string, DuplicacaoEncontrada[]> {\n  return duplicacoes.reduce(\n    (acc, dup) => {\n      const tipo = dup.tipoSimilaridade;\n      if (tipo) {\n        if (!acc[tipo]) {\n          acc[tipo] = [];\n        }\n        acc[tipo].push(dup);\n      }\n      return acc;\n    },\n    {} as Record<string, DuplicacaoEncontrada[]>,\n  );\n}\n"]}