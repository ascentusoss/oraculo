{"version":3,"file":"analista-python.js","sourceRoot":"","sources":["../../../src/analistas/plugins/analista-python.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport {\n  AnalystOrigins,\n  AnalystTypes,\n  PythonMessages,\n  SeverityLevels,\n} from '/messages/core/plugin-messages.js';\nimport { createLineLookup } from '/helpers/line-lookup.js';\nimport {\n  maskPythonComments,\n  maskPythonStringsAndComments,\n} from '/helpers/masking.js';\n\nimport { criarAnalista, criarOcorrencia } from '@';\n\nconst disableEnv = process.env.ORACULO_DISABLE_PLUGIN_PYTHON === '1';\n\ntype Msg = ReturnType<typeof criarOcorrencia>;\n\nfunction isPythonFile(relPath: string): boolean {\n  return /\\.(py|pyx|pyi)$/i.test(relPath);\n}\n\nfunction warn(\n  message: string,\n  relPath: string,\n  line?: number,\n  nivel: (typeof SeverityLevels)[keyof typeof SeverityLevels] = SeverityLevels.warning,\n): Msg {\n  return criarOcorrencia({\n    relPath,\n    mensagem: message,\n    linha: line,\n    nivel,\n    origem: AnalystOrigins.python,\n    tipo: AnalystTypes.python,\n  });\n}\n\nfunction collectPythonIssues(src: string, relPath: string): Msg[] {\n  const ocorrencias: Msg[] = [];\n\n  const lineOf = createLineLookup(src).lineAt;\n\n  // Reduz falsos positivos: evite detectar padrões dentro de strings/comentários.\n  const scan = maskPythonStringsAndComments(src);\n  // Algumas regras precisam enxergar literais (ex.: URLs/SQL em strings), mas ainda\n  // devem ignorar comentários.\n  const scanNoComments = maskPythonComments(src);\n\n  /* -------------------------- Type Hints & Code Quality -------------------------- */\n\n  // Funções sem type hints (heurística: def seguido de parênteses)\n  // Ignora __init__, main, properties, etc.\n  for (const match of scan.matchAll(\n    /^\\s*(?:async\\s+)?def\\s+([a-z_][a-z0-9_]*)\\s*\\((.*?)\\)(?!\\s*->)/gm,\n  )) {\n    const funcName = match[1] || '';\n    const line = lineOf(match.index);\n\n    // Ignora dunder methods, main, e métodos comuns sem tipo\n    if (/^__|main|__init__|setUp|tearDown|get_|set_/.test(funcName)) continue;\n\n    ocorrencias.push(warn(PythonMessages.missingTypeHints, relPath, line));\n  }\n\n  /* -------------------------- Security Issues -------------------------- */\n\n  // print() instead of logging\n  for (const match of scan.matchAll(/^\\s*print\\s*\\(/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMessages.printInsteadOfLog, relPath, line));\n  }\n\n  // eval() usage\n  for (const match of scan.matchAll(/\\beval\\s*\\(/gi)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(\n      warn(PythonMessages.evalUsage, relPath, line, SeverityLevels.error),\n    );\n  }\n\n  // exec() usage\n  for (const match of scan.matchAll(/\\bexec\\s*\\(/gi)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(\n      warn(PythonMessages.execUsage, relPath, line, SeverityLevels.error),\n    );\n  }\n\n  // subprocess(..., shell=True)\n  for (const match of scan.matchAll(\n    /\\bsubprocess\\.(?:run|Popen|call|check_call|check_output)\\s*\\([\\s\\S]*?\\)/g,\n  )) {\n    if (!/\\bshell\\s*=\\s*True\\b/.test(match[0])) continue;\n    const line = lineOf(match.index);\n    ocorrencias.push(\n      warn(\n        PythonMessages.subprocessShellTrue,\n        relPath,\n        line,\n        SeverityLevels.error,\n      ),\n    );\n  }\n\n  // pickle loads (RCE)\n  for (const match of scan.matchAll(/\\bpickle\\.(?:load|loads)\\s*\\(/gi)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(\n      warn(PythonMessages.pickleUsage, relPath, line, SeverityLevels.error),\n    );\n  }\n\n  // yaml.load sem Loader seguro\n  for (const match of scan.matchAll(/\\byaml\\.load\\s*\\([\\s\\S]*?\\)/gi)) {\n    const text = match[0] ?? '';\n    const hasSafeLoader =\n      /\\bLoader\\s*=\\s*yaml\\.(?:SafeLoader|CSafeLoader)\\b/.test(text);\n    const hasFullLoader =\n      /\\bLoader\\s*=\\s*yaml\\.(?:FullLoader|CFullLoader)\\b/.test(text);\n    const hasExplicitLoader = /\\bLoader\\s*=/.test(text);\n    if (hasSafeLoader) continue;\n    // FullLoader é melhor que default em versões antigas, mas ainda é discutível; marcamos aviso.\n    const line = lineOf(match.index);\n    ocorrencias.push(\n      warn(\n        PythonMessages.yamlUnsafeLoad,\n        relPath,\n        line,\n        hasFullLoader || hasExplicitLoader\n          ? SeverityLevels.warning\n          : SeverityLevels.error,\n      ),\n    );\n  }\n\n  // requests/urllib sem verify (HTTP inseguro)\n  for (const match of scanNoComments.matchAll(\n    /(?:requests|urllib)\\.(?:get|post|request)\\s*\\([^)]*\\)/g,\n  )) {\n    const hasVerify = /verify\\s*=/i.test(match[0]);\n    if (!hasVerify && /http:\\/\\//i.test(match[0])) {\n      const line = lineOf(match.index);\n      ocorrencias.push(warn(PythonMessages.httpWithoutVerify, relPath, line));\n    }\n  }\n\n  // SQL injection patterns (simples)\n  // - execute(f\"SELECT ... {var} ...\")\n  // - execute(f'SELECT ... {var} ...')\n  for (const match of scanNoComments.matchAll(\n    /\\b(?:execute|executemany|executescript)\\s*\\(\\s*f(['\"])(?:SELECT|INSERT|UPDATE|DELETE)[\\s\\S]*?\\1/gi,\n  )) {\n    const text = match[0] ?? '';\n    // Heurística: f-string com interpolação sugere concatenação de SQL.\n    if (!/\\{[^}]+\\}/.test(text)) continue;\n    const line = lineOf(match.index);\n    ocorrencias.push(\n      warn(PythonMessages.sqlInjection, relPath, line, SeverityLevels.error),\n    );\n  }\n\n  /* -------------------------- Exception Handling -------------------------- */\n\n  // Bare except\n  for (const match of scan.matchAll(/^\\s*except\\s*:\\s*$/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMessages.broadExcept, relPath, line));\n  }\n\n  // except ... pass (bad practice)\n  for (const match of scan.matchAll(\n    /except\\s+\\w+\\s*(?:as\\s+\\w+)?\\s*:\\s*pass/g,\n  )) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMessages.passInExcept, relPath, line));\n  }\n\n  // bare raise (contextless)\n  for (const match of scan.matchAll(\n    /except\\s+\\w+\\s*(?:as\\s+\\w+)?\\s*:\\s*\\n\\s*raise\\s*\\n/gm,\n  )) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMessages.bareRaise, relPath, line));\n  }\n\n  /* -------------------------- Code Quality & Best Practices -------------------------- */\n\n  // global keyword (code smell)\n  for (const match of scan.matchAll(/^\\s*global\\s+\\w+/gm)) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMessages.globalKeyword, relPath, line));\n  }\n\n  // Mutable default arguments\n  for (const match of scan.matchAll(\n    /def\\s+\\w+\\s*\\([^)]*=\\s*(?:\\[|\\{)[^\\]}]*(?:\\]|\\})/g,\n  )) {\n    const line = lineOf(match.index);\n    ocorrencias.push(warn(PythonMessages.mutableDefault, relPath, line));\n  }\n\n  /* -------------------------- Performance Hints -------------------------- */\n\n  // Loop that could be list comprehension (simple heuristic)\n  for (const match of scan.matchAll(\n    /for\\s+\\w+\\s+in\\s+\\w+:\\s*\\n\\s*(\\w+)\\.append\\s*\\(/g,\n  )) {\n    const line = lineOf(match.index);\n    // Apenas sugerir se parece simples (sem múltiplas linhas complexas)\n    ocorrencias.push(\n      warn(\n        PythonMessages.listComprehensionOpportunity,\n        relPath,\n        line,\n        SeverityLevels.suggestion,\n      ),\n    );\n  }\n\n  // Iterating over dict without .items()\n  for (const match of scan.matchAll(\n    /for\\s+\\w+\\s+in\\s+(\\w+):\\s*\\n\\s*(?:value|val)\\s*=\\s*\\1\\[/gm,\n  )) {\n    const line = lineOf(match.index);\n    ocorrencias.push(\n      warn(\n        PythonMessages.loopingOverDict,\n        relPath,\n        line,\n        SeverityLevels.suggestion,\n      ),\n    );\n  }\n\n  return ocorrencias;\n}\n\nexport const analistaPython = criarAnalista({\n  nome: 'analista-python',\n  categoria: 'framework',\n  descricao: 'Heurísticas leves para Python (boas práticas e segurança).',\n  global: false,\n  test: (relPath: string): boolean => isPythonFile(relPath),\n  aplicar: async (src, relPath): Promise<Msg[] | null> => {\n    if (disableEnv) return null;\n    if (relPath.includes('src/analistas/plugins/analista-python.ts'))\n      return null;\n    const msgs = collectPythonIssues(src, relPath);\n    return msgs.length ? msgs : null;\n  },\n});\n\nexport default analistaPython;\n"]}