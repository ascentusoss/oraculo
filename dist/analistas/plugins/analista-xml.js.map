{"version":3,"file":"analista-xml.js","sourceRoot":"","sources":["../../../src/analistas/plugins/analista-xml.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport {\n  AnalystOrigins,\n  AnalystTypes,\n  SeverityLevels,\n  XmlMessages,\n} from '@core/messages/core/plugin-messages.js';\nimport { createLineLookup } from '@shared/helpers/line-lookup.js';\nimport { maskXmlNonCode } from '@shared/helpers/masking.js';\n\nimport { criarAnalista, criarOcorrencia } from '@';\n\nconst disableEnv = process.env.ORACULO_DISABLE_PLUGIN_XML === '1';\n\ntype Msg = ReturnType<typeof criarOcorrencia>;\n\nfunction warn(\n  message: string,\n  relPath: string,\n  line?: number,\n  nivel: (typeof SeverityLevels)[keyof typeof SeverityLevels] = SeverityLevels.warning,\n): Msg {\n  return criarOcorrencia({\n    relPath,\n    mensagem: message,\n    linha: line,\n    nivel,\n    origem: AnalystOrigins.xml,\n    tipo: AnalystTypes.xml,\n  });\n}\n\nfunction collectXmlIssues(src: string, relPath: string): Msg[] {\n  const ocorrencias: Msg[] = [];\n\n  // Para reduzir falsos positivos (ex.: exemplos comentados), analisamos uma versão mascarada\n  // preservando quebras de linha para manter cálculo de linha consistente.\n  const scan = maskXmlNonCode(src);\n  const lineOf = createLineLookup(scan).lineAt;\n\n  // Prolog (opcional): só alerta se o arquivo parece XML completo e começa direto com tag.\n  // Fragmentos XML (como em SOAP ou RSS) podem não ter prolog.\n  const trimmed = src.trimStart();\n  const seemsCompleteDocument =\n    /^<\\w/i.test(trimmed) && !trimmed.includes('<?xml');\n  if (seemsCompleteDocument && /^</.test(trimmed)) {\n    ocorrencias.push(\n      warn(XmlMessages.xmlPrologAusente, relPath, 1, SeverityLevels.info),\n    );\n  }\n\n  // Validação básica de estrutura XML (tags balanceadas)\n  // Melhorar regex para capturar tags com atributos complexos, namespaces, etc.\n  const tagRegex = /<\\/?([a-zA-Z_][\\w.-]*(?::[a-zA-Z_][\\w.-]*)?)(?:\\s[^>]*)?>/g;\n  let match;\n  const tagStack: string[] = [];\n  while ((match = tagRegex.exec(scan)) !== null) {\n    const fullTag = match[0];\n    const tagName = match[1];\n    const line = lineOf(match.index);\n\n    if (fullTag.startsWith('</')) {\n      // Tag de fechamento\n      const expected = tagStack.pop();\n      if (expected !== tagName) {\n        ocorrencias.push(\n          warn(\n            XmlMessages.invalidXmlStructure,\n            relPath,\n            line,\n            SeverityLevels.error,\n          ),\n        );\n        break; // Para evitar cascata de erros\n      }\n    } else if (!fullTag.endsWith('/>')) {\n      // Tag de abertura (não self-closing)\n      tagStack.push(tagName);\n    }\n  }\n\n  if (tagStack.length > 0) {\n    ocorrencias.push(\n      warn(\n        XmlMessages.invalidXmlStructure,\n        relPath,\n        lineOf(scan.length),\n        SeverityLevels.error,\n      ),\n    );\n  }\n\n  // Namespaces não declarados\n  // Melhorar para considerar declarações no scan mascarado e evitar falsos positivos\n  const xmlnsRegex = /xmlns(?::([a-zA-Z_][\\w.-]*))?\\s*=\\s*['\"][^'\"]*['\"]/g;\n  const declaredNamespaces = new Set<string>();\n  while ((match = xmlnsRegex.exec(scan)) !== null) {\n    const prefix = match[1];\n    if (prefix) declaredNamespaces.add(prefix);\n  }\n\n  const prefixRegex = /([a-zA-Z_][\\w.-]*):[a-zA-Z_][\\w.-]*/g;\n  while ((match = prefixRegex.exec(scan)) !== null) {\n    const prefix = match[1];\n    if (\n      !declaredNamespaces.has(prefix) &&\n      prefix !== 'xml' &&\n      prefix !== 'xmlns'\n    ) {\n      const line = lineOf(match.index);\n      ocorrencias.push(\n        warn(\n          XmlMessages.namespaceUndeclared(prefix),\n          relPath,\n          line,\n          SeverityLevels.warning,\n        ),\n      );\n    }\n  }\n\n  // DOCTYPE + ENTITY (XXE)\n  for (const m of scan.matchAll(/<!DOCTYPE\\b[\\s\\S]*?(?:\\]\\s*>|>)/gi)) {\n    const chunk = m[0] ?? '';\n    const hasExternalId = /\\b(SYSTEM|PUBLIC)\\b/i.test(chunk);\n    const line = lineOf(m.index);\n    ocorrencias.push(warn(XmlMessages.doctypeDetectado, relPath, line));\n    if (hasExternalId) {\n      ocorrencias.push(\n        warn(\n          XmlMessages.doctypeExternoDetectado,\n          relPath,\n          line,\n          SeverityLevels.error,\n        ),\n      );\n    }\n  }\n\n  for (const m of scan.matchAll(/<!ENTITY\\b[\\s\\S]*?>/gi)) {\n    const chunk = m[0] ?? '';\n    const hasExternal = /\\b(SYSTEM|PUBLIC)\\b/i.test(chunk);\n    const isParamEntity = /<!ENTITY\\s+%/i.test(chunk);\n    const hasDangerousSystemId =\n      /\\bSYSTEM\\b[\\s\\S]*?['\"]\\s*(file:|ftp:|gopher:|jar:|php:|data:)/i.test(\n        chunk,\n      );\n    const line = lineOf(m.index);\n\n    if (isParamEntity) {\n      ocorrencias.push(\n        warn(\n          XmlMessages.entidadeParametroDetectada,\n          relPath,\n          line,\n          SeverityLevels.warning,\n        ),\n      );\n    }\n\n    // Detecta entidades com expansão potencialmente grande (Billion Laughs)\n    // Focar em entidades recursivas ou com referências múltiplas, não apenas tamanho\n    const entityValue = chunk.match(\n      /<!ENTITY\\s+[^'\"]*\\s+['\"]([^'\"]*)['\"]/i,\n    )?.[1];\n    if (entityValue && entityValue.includes('&') && entityValue.length > 100) {\n      // Heurística simples: entidades que referenciam outras e são grandes\n      ocorrencias.push(\n        warn(\n          XmlMessages.largeEntityExpansion,\n          relPath,\n          line,\n          SeverityLevels.error,\n        ),\n      );\n    }\n\n    ocorrencias.push(\n      warn(\n        hasExternal\n          ? XmlMessages.entidadeExternaDetectada\n          : XmlMessages.entidadeDetectada,\n        relPath,\n        line,\n        hasExternal || hasDangerousSystemId\n          ? SeverityLevels.error\n          : SeverityLevels.warning,\n      ),\n    );\n  }\n\n  // XInclude (carregamento externo)\n  for (const m of scan.matchAll(/<\\s*(?:xi|xinclude):include\\b[^>]*>/gi)) {\n    ocorrencias.push(\n      warn(XmlMessages.xincludeDetectado, relPath, lineOf(m.index)),\n    );\n  }\n\n  // CDATA em atributos (inválido)\n  for (const m of scan.matchAll(/=\\s*['\"]\\s*<![CDATA[[^]]*]]>\\s*['\"]/gi)) {\n    ocorrencias.push(\n      warn(\n        XmlMessages.cdataInAttribute,\n        relPath,\n        lineOf(m.index),\n        SeverityLevels.error,\n      ),\n    );\n  }\n\n  return ocorrencias;\n}\n\nexport const analistaXml = criarAnalista({\n  nome: 'analista-xml',\n  categoria: 'markup',\n  descricao:\n    'Heurísticas leves para XML (foco em segurança/XXE e compatibilidade).',\n  global: false,\n  test: (relPath: string): boolean => /\\.xml$/i.test(relPath),\n  aplicar: async (src, relPath): Promise<Msg[] | null> => {\n    if (disableEnv) return null;\n    const msgs = collectXmlIssues(src, relPath);\n    return msgs.length ? msgs : null;\n  },\n});\n\nexport default analistaXml;\n"]}