{"version":3,"file":"analista-svg.js","sourceRoot":"","sources":["../../../src/analistas/plugins/analista-svg.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\nimport {\n  AnalystOrigins,\n  AnalystTypes,\n  SeverityLevels,\n  SvgMessages,\n} from '@core/messages/core/plugin-messages.js';\nimport {\n  otimizarSvgLikeSvgo,\n  shouldSugerirOtimizacaoSvg,\n} from '@shared/impar/svgs.js';\n\nimport type { Ocorrencia } from '@';\nimport { criarAnalista, criarOcorrencia } from '@';\n\nconst disableEnv = process.env.ORACULO_DISABLE_PLUGIN_SVG === '1';\n\ntype Msg = ReturnType<typeof criarOcorrencia>;\n\nfunction findLine(src: string, index = 0): number {\n  const safeIndex = Math.max(0, index);\n  let line = 1;\n  for (let i = 0; i < safeIndex && i < src.length; i++) {\n    if (src.charCodeAt(i) === 10) line++;\n  }\n  return line;\n}\n\nfunction findFirstMatchLine(src: string, re: RegExp, fallbackLine = 1): number {\n  const idx = src.search(re);\n  if (idx < 0) return fallbackLine;\n  return findLine(src, idx);\n}\n\nfunction msg(\n  message: string,\n  relPath: string,\n  nivel: (typeof SeverityLevels)[keyof typeof SeverityLevels] = SeverityLevels.warning,\n  line = 1,\n): Msg {\n  return criarOcorrencia({\n    relPath,\n    mensagem: message,\n    linha: line,\n    nivel,\n    origem: AnalystOrigins.svg,\n    tipo: AnalystTypes.svg,\n  });\n}\n\nexport const analistaSvg = criarAnalista({\n  nome: 'analista-svg',\n  categoria: 'assets',\n  descricao: 'Heurísticas para SVG + sugestão de otimização (modo Oráculo).',\n  global: false,\n  test: (relPath: string): boolean => /\\.svg$/i.test(relPath),\n  aplicar: async (src, relPath): Promise<Ocorrencia[] | null> => {\n    if (disableEnv) return null;\n    const ocorrencias: Ocorrencia[] = [];\n\n    if (!/<svg\\b/i.test(src)) {\n      ocorrencias.push(\n        msg(SvgMessages.naoPareceSvg, relPath, SeverityLevels.warning, 1),\n      );\n      return ocorrencias;\n    }\n\n    const idxSvg = src.search(/<svg\\b/i);\n    const linhaSvg = idxSvg >= 0 ? findLine(src, idxSvg) : 1;\n\n    const opt = otimizarSvgLikeSvgo({ svg: src });\n\n    // Segurança\n    for (const w of opt.warnings) {\n      if (w === 'script-inline') {\n        const line = findFirstMatchLine(src, /<script\\b/i, linhaSvg);\n        ocorrencias.push(\n          msg(SvgMessages.scriptInline, relPath, SeverityLevels.error, line),\n        );\n      } else if (w === 'evento-inline') {\n        const line = findFirstMatchLine(src, /\\son\\w+\\s*=\\s*['\"]/i, linhaSvg);\n        ocorrencias.push(\n          msg(SvgMessages.eventoInline, relPath, SeverityLevels.warning, line),\n        );\n      } else if (w === 'javascript-url') {\n        const line = findFirstMatchLine(src, /javascript:\\s*/i, linhaSvg);\n        ocorrencias.push(\n          msg(SvgMessages.javascriptUrl, relPath, SeverityLevels.error, line),\n        );\n      }\n    }\n\n    // Boas práticas\n    if (!/\\bviewBox\\s*=\\s*['\"][^'\"]+['\"]/i.test(src)) {\n      ocorrencias.push(\n        msg(SvgMessages.semViewBox, relPath, SeverityLevels.info, linhaSvg),\n      );\n    }\n\n    // Otimização (diferença de bytes)\n    if (\n      opt.changed &&\n      opt.originalBytes > opt.optimizedBytes &&\n      shouldSugerirOtimizacaoSvg(opt.originalBytes, opt.optimizedBytes)\n    ) {\n      ocorrencias.push(\n        msg(\n          SvgMessages.podeOtimizar(\n            opt.originalBytes,\n            opt.optimizedBytes,\n            opt.mudancas,\n          ),\n          relPath,\n          SeverityLevels.info,\n          linhaSvg,\n        ),\n      );\n    }\n\n    return ocorrencias.length ? ocorrencias : null;\n  },\n});\n\nexport default analistaSvg;\n"]}