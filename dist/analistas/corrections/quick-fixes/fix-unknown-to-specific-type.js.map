{"version":3,"file":"fix-unknown-to-specific-type.js","sourceRoot":"","sources":["../../../../src/analistas/corrections/quick-fixes/fix-unknown-to-specific-type.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * Quick Fix: Replace unknown with specific types\n * Mais conservador que fix-any - requer confiança >= 90%\n */\n\nimport type { Node } from '@babel/types';\nimport {\n  buildTypesRelPathPosix,\n  getTypesDirectoryDisplay,\n} from '@core/config/conventions.js';\nimport { MENSAGENS_FIX_TYPES } from '@core/messages/index.js';\n\nimport type { QuickFix, QuickFixResult, TypeSafetyWarning } from '@';\n\nimport {\n  isInStringOrComment,\n  isLegacyOrVendorFile,\n  isUnknownInGenericContext,\n} from '../type-safety/context-analyzer.js';\nimport { analyzeUnknownUsage } from '../type-safety/type-analyzer.js';\nimport { createTypeDefinition } from '../type-safety/type-creator.js';\nimport { validateTypeReplacement } from '../type-safety/type-validator.js';\n\nexport const fixUnknownToSpecificType: QuickFix = {\n  id: 'fix-unknown-to-specific-type',\n  title: MENSAGENS_FIX_TYPES.fixUnknown.title,\n  description: MENSAGENS_FIX_TYPES.fixUnknown.description,\n  pattern: /:\\s*unknown\\b/g,\n  category: 'style',\n  confidence: 75, // Mais conservador que any\n\n  shouldApply: (\n    match: RegExpMatchArray,\n    fullCode: string,\n    lineContext: string,\n    filePath?: string,\n  ) => {\n    // 1. Verificar contexto básico\n    if (isInStringOrComment(fullCode, match.index || 0)) {\n      return false;\n    }\n\n    // 2. Não modificar arquivos de definição\n    if (filePath?.includes('.d.ts') || filePath?.includes('/@types/')) {\n      return false;\n    }\n\n    // 3. Não modificar legado/vendor\n    if (isLegacyOrVendorFile(filePath)) {\n      return false;\n    }\n\n    // 4. Verificar se unknown está em contexto genérico apropriado\n    if (isUnknownInGenericContext(fullCode, match.index || 0)) {\n      return false; // unknown é apropriado aqui (entrada genérica, deserialização, etc)\n    }\n\n    return true;\n  },\n\n  fix: (match: RegExpMatchArray, fullCode: string) => {\n    // Retornar código sem modificação por padrão\n    return fullCode;\n  },\n};\n\n/**\n * Versão assíncrona com análise completa (conservador)\n */\nexport async function fixUnknownToSpecificTypeAsync(\n  match: RegExpMatchArray,\n  fullCode: string,\n  filePath: string,\n  ast: Node | null,\n): Promise<QuickFixResult> {\n  try {\n    // 1. Analisar uso (mais conservador que any)\n    const typeAnalysis = await analyzeUnknownUsage(\n      match,\n      fullCode,\n      filePath,\n      ast,\n    );\n\n    // 2. Estratégia mais conservadora (requer >= 90% confiança)\n    if (typeAnalysis.confidence >= 90) {\n      // ALTA CONFIANÇA: Criar interface dedicada\n\n      const typePath = await createTypeDefinition(typeAnalysis, filePath);\n      const importStatement = `import type { ${typeAnalysis.typeName} } from '${typePath}';\\n`;\n\n      // Adicionar import e substituir unknown\n      const lines = fullCode.split('\\n');\n      const importIndex = findImportInsertionPoint(lines);\n      lines.splice(importIndex, 0, importStatement);\n\n      let fixedCode = lines.join('\\n');\n      fixedCode = fixedCode.replace(match[0], `: ${typeAnalysis.typeName}`);\n\n      // Validar\n      const validation = await validateTypeReplacement(\n        fullCode,\n        fixedCode,\n        typeAnalysis,\n      );\n\n      if (!validation.isCompatible) {\n        return {\n          code: fullCode,\n          applied: false,\n          reason: `Validação falhou: ${validation.errors.join(', ')}`,\n        };\n      }\n\n      return {\n        code: fixedCode,\n        applied: true,\n        additionalChanges: [\n          {\n            type: 'add-import',\n            content: importStatement,\n          },\n          {\n            type: 'create-type-file',\n            content: typeAnalysis.typeDefinition,\n            path: buildTypesRelPathPosix(typeAnalysis.suggestedPath),\n          },\n        ],\n      };\n    } else if (typeAnalysis.confidence >= 70) {\n      // MÉDIA CONFIANÇA: Sugerir tipo\n      const warning: TypeSafetyWarning = {\n        type: 'type-suggestion',\n        message: `unknown pode ser substituído por tipo específico: ${typeAnalysis.inferredType}`,\n        suggestion: `Crie interface em ${buildTypesRelPathPosix(typeAnalysis.suggestedPath)}`,\n        confidence: typeAnalysis.confidence,\n      };\n\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança média (${typeAnalysis.confidence}%) - sugestão apenas`,\n        warnings: [warning],\n      };\n    } else {\n      // BAIXA CONFIANÇA: Manter unknown\n      const warning: TypeSafetyWarning = {\n        type: 'keep-unknown',\n        message:\n          'unknown apropriado aqui (entrada genérica ou baixa confiança)',\n        suggestion: `Se possível, adicione type guards ou crie tipo dedicado em ${getTypesDirectoryDisplay()}`,\n      };\n\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança baixa (${typeAnalysis.confidence}%) - manter unknown`,\n        warnings: [warning],\n      };\n    }\n  } catch (error) {\n    return {\n      code: fullCode,\n      applied: false,\n      reason: `Erro na análise: ${error instanceof Error ? error.message : String(error)}`,\n    };\n  }\n}\n\n/**\n * Encontra ponto de inserção para import\n */\nfunction findImportInsertionPoint(lines: string[]): number {\n  let lastImportIndex = -1;\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i].trim();\n\n    if (\n      line.startsWith('//') ||\n      line.startsWith('/*') ||\n      line.startsWith('*')\n    ) {\n      continue;\n    }\n\n    if (line.startsWith('import ')) {\n      lastImportIndex = i;\n    }\n\n    if (line && !line.startsWith('import ') && lastImportIndex !== -1) {\n      break;\n    }\n  }\n\n  return lastImportIndex + 1;\n}\n"]}