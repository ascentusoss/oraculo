{"version":3,"file":"fix-any-to-proper-type.js","sourceRoot":"","sources":["../../../../src/analistas/corrections/quick-fixes/fix-any-to-proper-type.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n/**\n * Quick Fix: Replace any with proper types\n * Analisa uso de `any` e infere/cria tipos corretos\n */\n\nimport type { Node } from '@babel/types';\nimport { buildTypesRelPathPosix } from '@core/config/conventions.js';\nimport { MENSAGENS_FIX_TYPES } from '@core/messages/index.js';\n\nimport type { QuickFix, QuickFixResult, TypeSafetyWarning } from '@';\n\nimport {\n  isAnyInGenericFunction,\n  isInStringOrComment,\n  isLegacyOrVendorFile,\n  isTypeScriptContext,\n} from '../type-safety/context-analyzer.js';\nimport { analyzeTypeUsage } from '../type-safety/type-analyzer.js';\nimport { createTypeDefinition } from '../type-safety/type-creator.js';\nimport { validateTypeReplacement } from '../type-safety/type-validator.js';\n\nexport const fixAnyToProperType: QuickFix = {\n  id: 'fix-any-to-proper-type',\n  title: MENSAGENS_FIX_TYPES.fixAny.title,\n  description: MENSAGENS_FIX_TYPES.fixAny.description,\n  pattern: /:\\s*any\\b/g,\n  category: 'style', // Type safety é considerado 'style' pois não afeta execução\n  confidence: 70, // Média - requer análise contextual\n\n  shouldApply: (\n    match: RegExpMatchArray,\n    fullCode: string,\n    lineContext: string,\n    filePath?: string,\n  ) => {\n    // 1. Verificar contexto básico\n    if (isInStringOrComment(fullCode, match.index || 0)) {\n      return false;\n    }\n\n    // 2. Verificar contexto TypeScript (type assertion, etc)\n    if (isTypeScriptContext(fullCode, match.index || 0)) {\n      return false;\n    }\n\n    // 3. Não modificar arquivos de definição de tipos\n    if (filePath?.includes('.d.ts') || filePath?.includes('/@types/')) {\n      return false;\n    }\n\n    // 4. Não modificar vendor/node_modules\n    if (isLegacyOrVendorFile(filePath)) {\n      return false;\n    }\n\n    // 5. Verificar se any está em função genérica apropriada\n    if (isAnyInGenericFunction(fullCode, match.index || 0)) {\n      return false; // any pode ser apropriado aqui\n    }\n\n    return true;\n  },\n\n  fix: (match: RegExpMatchArray, fullCode: string) => {\n    // Retornar código sem modificação por padrão\n    // A aplicação real deve ser feita via fixAsync\n    return fullCode;\n  },\n};\n\n/**\n * Versão assíncrona do fix que faz análise completa\n */\nexport async function fixAnyToProperTypeAsync(\n  match: RegExpMatchArray,\n  fullCode: string,\n  filePath: string,\n  ast: Node | null,\n): Promise<QuickFixResult> {\n  try {\n    // 1. Analisar uso do tipo\n    const typeAnalysis = await analyzeTypeUsage(match, fullCode, filePath, ast);\n\n    // 2. Estratégia baseada em confiança\n    if (typeAnalysis.confidence >= 85) {\n      // ALTA CONFIANÇA: Aplicar tipo automaticamente\n\n      if (typeAnalysis.isSimpleType) {\n        // Tipo primitivo: substituir diretamente\n        const fixedCode = fullCode.replace(\n          match[0],\n          `: ${typeAnalysis.inferredType}`,\n        );\n\n        // Validar resultado\n        const validation = await validateTypeReplacement(\n          fullCode,\n          fixedCode,\n          typeAnalysis,\n        );\n\n        if (!validation.isCompatible) {\n          return {\n            code: fullCode,\n            applied: false,\n            reason: `Validação falhou: ${validation.errors.join(', ')}`,\n            warnings: validation.warnings.map((w) => ({\n              type: 'unsafe-type',\n              message: w,\n              suggestion: 'Revise manualmente',\n            })),\n          };\n        }\n\n        return {\n          code: fixedCode,\n          applied: true,\n          warnings: validation.warnings.map((w) => ({\n            type: 'type-suggestion',\n            message: w,\n            suggestion: MENSAGENS_FIX_TYPES.validacao.revisar,\n          })),\n        };\n      } else {\n        // Tipo complexo: criar interface\n        const typePath = await createTypeDefinition(typeAnalysis, filePath);\n        const importStatement = `import type { ${typeAnalysis.typeName} } from '${typePath}';\\n`;\n\n        // Adicionar import no topo e substituir any\n        const lines = fullCode.split('\\n');\n        const importIndex = findImportInsertionPoint(lines);\n        lines.splice(importIndex, 0, importStatement);\n\n        let fixedCode = lines.join('\\n');\n        fixedCode = fixedCode.replace(match[0], `: ${typeAnalysis.typeName}`);\n\n        // Validar resultado\n        const validation = await validateTypeReplacement(\n          fullCode,\n          fixedCode,\n          typeAnalysis,\n        );\n\n        if (!validation.isCompatible) {\n          return {\n            code: fullCode,\n            applied: false,\n            reason: `Validação falhou: ${validation.errors.join(', ')}`,\n          };\n        }\n\n        return {\n          code: fixedCode,\n          applied: true,\n          additionalChanges: [\n            {\n              type: 'add-import',\n              content: importStatement,\n            },\n            {\n              type: 'create-type-file',\n              content: typeAnalysis.typeDefinition,\n              path: buildTypesRelPathPosix(typeAnalysis.suggestedPath),\n            },\n          ],\n        };\n      }\n    } else if (typeAnalysis.confidence >= 60) {\n      // MÉDIA CONFIANÇA: Sugerir mas não aplicar\n      const warning: TypeSafetyWarning = {\n        type: 'type-suggestion',\n        message: MENSAGENS_FIX_TYPES.warnings.confiancaMedia(\n          typeAnalysis.confidence,\n          typeAnalysis.inferredType,\n        ),\n        suggestion: MENSAGENS_FIX_TYPES.warnings.criarTipoDedicado(\n          typeAnalysis.suggestedPath,\n        ),\n        confidence: typeAnalysis.confidence,\n      };\n\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança média (${typeAnalysis.confidence}%) - sugestão apenas`,\n        warnings: [warning],\n      };\n    } else {\n      // BAIXA CONFIANÇA: Apenas avisar\n      const warning: TypeSafetyWarning = {\n        type: 'unsafe-type',\n        message: MENSAGENS_FIX_TYPES.warnings.confiancaBaixa(\n          typeAnalysis.confidence,\n        ),\n        suggestion: MENSAGENS_FIX_TYPES.warnings.useTiposCentralizados(),\n        needsManualReview: true,\n      };\n\n      return {\n        code: fullCode,\n        applied: false,\n        reason: `Confiança baixa (${typeAnalysis.confidence}%)`,\n        warnings: [warning],\n      };\n    }\n  } catch (error) {\n    return {\n      code: fullCode,\n      applied: false,\n      reason: MENSAGENS_FIX_TYPES.erros.analise(\n        error instanceof Error ? error.message : String(error),\n      ),\n    };\n  }\n}\n\n/**\n * Encontra ponto de inserção para import\n */\nfunction findImportInsertionPoint(lines: string[]): number {\n  let lastImportIndex = -1;\n\n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i].trim();\n\n    // Pular comentários no topo\n    if (\n      line.startsWith('//') ||\n      line.startsWith('/*') ||\n      line.startsWith('*')\n    ) {\n      continue;\n    }\n\n    // Encontrar último import\n    if (line.startsWith('import ')) {\n      lastImportIndex = i;\n    }\n\n    // Se encontrou código não-import, parar\n    if (line && !line.startsWith('import ') && lastImportIndex !== -1) {\n      break;\n    }\n  }\n\n  // Inserir após último import ou no topo\n  return lastImportIndex + 1;\n}\n"]}