{"version":3,"file":"reescrever-testes-aliases.js","sourceRoot":"","sources":["../../../src/analistas/corrections/reescrever-testes-aliases.ts"],"names":[],"mappings":"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","sourcesContent":["// SPDX-License-Identifier: MIT\n// @oraculo-disable tipo-literal-inline-complexo\n// Justificativa: tipos locais usados internamente para parsing de caminhos\nimport fsSync from 'node:fs';\nimport path from 'node:path';\n\nconst _TOP_DIRS = new Set([\n  'analistas',\n  'arquitetos',\n  'cli',\n  'guardian',\n  'nucleo',\n  'relatorios',\n  'tipos',\n  'auto',\n]);\n\nconst LEGACY_ALIAS_MAP = new Map<string, string>();\n\nfunction toPosix(p: string): string {\n  return p.replace(/\\\\/g, '/');\n}\nfunction exists(p: string): boolean {\n  try {\n    return fsSync.existsSync(p);\n  } catch {\n    return false;\n  }\n}\n\nfunction pathFromAlias(aliasSpec: string, srcRoot: string): string {\n  const spec = aliasSpec.replace(/^@/, '');\n  const parts = spec.split('/');\n  const top = parts.shift();\n  return path.join(srcRoot, top ?? '', parts.join('/'));\n}\n\nexport function pickExtForAlias(aliasBase: string, srcRoot: string): string {\n  const absTs = pathFromAlias(`${aliasBase}.ts`, srcRoot);\n  const absJs = pathFromAlias(`${aliasBase}.js`, srcRoot);\n  if (exists(absTs)) return `${aliasBase}.ts`;\n  if (exists(absJs)) return `${aliasBase}.js`;\n  return `${aliasBase}.ts`;\n}\n\nexport function rewriteToAlias(\n  spec: string,\n  ctx: {\n    fileAbs: string;\n    scope?: string;\n    withinScope?: string;\n    srcRoot: string;\n  },\n): { changed: boolean; value: string } {\n  const posixSpec = toPosix(spec);\n  if (\n    posixSpec.startsWith('@') ||\n    /^([a-zA-Z]+:|node:|[a-zA-Z0-9_-]+)$/.test(posixSpec)\n  ) {\n    if (!posixSpec.startsWith('@')) return { changed: false, value: spec };\n    const withoutExt = posixSpec.replace(/\\.(ts|js|mjs|cjs|tsx|jsx)$/i, '');\n    let mapped = LEGACY_ALIAS_MAP.get(withoutExt);\n    if (!mapped && withoutExt.startsWith('@cli/src/')) mapped = withoutExt;\n    if (mapped) {\n      const withExt = pickExtForAlias(mapped, ctx.srcRoot);\n      return { changed: true, value: withExt };\n    }\n    return { changed: false, value: spec };\n  }\n  return { changed: false, value: spec };\n}\n\nexport function transformCodeForTests(\n  code: string,\n  ctx: {\n    fileAbs: string;\n    scope?: string;\n    withinScope?: string;\n    srcRoot: string;\n  },\n): { code: string; changed: boolean } {\n  let changed = false;\n  const rewrite = (spec: string) => rewriteToAlias(spec, ctx);\n\n  code = code.replace(\n    /(import\\s+[^'\"\\n]+?from\\s+)([\"'])([^\"']+?)\\2/g,\n    (m, p1, q, spec) => {\n      const result = rewrite(spec);\n      if (!result.changed) return m;\n      changed = true;\n      return `${p1}${q}${result.value}${q}`;\n    },\n  );\n\n  code = code.replace(/(import\\s*)([\"'])([^\"']+?)\\2/g, (m, p1, q, spec) => {\n    const result = rewrite(spec);\n    if (!result.changed) return m;\n    changed = true;\n    return `${p1}${q}${result.value}${q}`;\n  });\n\n  code = code.replace(\n    /(import\\s*\\()(\\s*[\"'])([^\"']+?)([\"']\\s*\\))/g,\n    (m, p1, q1, spec, q2) => {\n      const result = rewrite(spec);\n      if (!result.changed) return m;\n      changed = true;\n      return `${p1}${q1}${result.value}${q2}`;\n    },\n  );\n\n  code = code.replace(\n    /(vi\\.(?:do)?mock\\s*\\()(\\s*[\"'])([^\"']+?)([\"'])(\\s*,?)/g,\n    (m, p1, q1, spec, q2, comma = '') => {\n      const result = rewrite(spec);\n      if (!result.changed) return m;\n      changed = true;\n      return `${p1}${q1}${result.value}${q2}${comma}`;\n    },\n  );\n\n  return { code, changed };\n}\n"]}